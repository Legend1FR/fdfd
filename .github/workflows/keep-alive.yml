name: Keep Server Alive

on:
  schedule:
    # تشغيل كل 8 دقائق
    - cron: '*/8 * * * *'
  workflow_dispatch: # للتشغيل اليدوي

jobs:
  ping:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ping Server
      run: |
        echo "🔄 Pinging server at $(date)"
        
        # ping الصفحة الرئيسية
        response=$(curl -s -o /dev/null -w "%{http_code}" "https://cdcdcd.onrender.com/health" || echo "000")
        
        if [ "$response" = "200" ]; then
          echo "✅ Server is alive - Status: $response"
          
          # جلب معلومات إضافية
          health_data=$(curl -s "https://cdcdcd.onrender.com/health" || echo "{}")
          echo "📊 Health check response:"
          echo "$health_data" | jq '.' 2>/dev/null || echo "$health_data"
          
        else
          echo "❌ Server might be sleeping - Status: $response"
          
          # محاولة ping الـ ping endpoint أيضاً
          ping_response=$(curl -s -o /dev/null -w "%{http_code}" "https://cdcdcd.onrender.com/ping" || echo "000")
          echo "📡 Ping endpoint status: $ping_response"
          
          # إذا فشل الـ health check لكن نجح الـ ping، فالسيرفر يعمل
          if [ "$ping_response" = "200" ]; then
            echo "✅ Server is actually alive (ping successful)"
          else
            echo "🚨 Server appears to be down"
            exit 1
          fi
        fi
        
        echo "🕒 Ping completed at $(date)"

    - name: Alternative Ping
      if: failure()
      run: |
        echo "🔄 Trying alternative ping methods..."
        
        # محاولة ping الصفحة الرئيسية
        curl -f "https://cdcdcd.onrender.com/" || echo "Main page failed"
        
        # محاولة ping endpoint بسيط
        curl -f "https://cdcdcd.onrender.com/ping" || echo "Ping endpoint failed"
        
        # محاولة ping status page
        curl -f "https://cdcdcd.onrender.com/status" || echo "Status page failed"
