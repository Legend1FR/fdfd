const { TelegramClient } = require("telegram");
const { StringSession } = require("telegram/sessions");
const fs = require("fs");
const input = require("input");
const http = require("http");
const https = require("https");
const { performance } = require('perf_hooks');

// ุจูุงูุงุช ุงูุฏุฎูู ุชููุงุฆูุฉ ููุณูุฑูุฑ
const PHONE_NUMBER = "+967xxxxxxxxx";  // ุถุน ุฑููู ููุง
const PASSWORD = "YOUR_PASSWORD"; // ุฅุฐุง ูุงู ูุฏูู ูููุฉ ูุฑูุฑ 2FA
const PHONE_CODE = undefined; // ูููู ุชุฑูู undefined ููุชู ุชุฌุงููู

const apiId = 23299626;
const apiHash = "89de50a19288ec535e8b008ae2ff268d";

console.log("๐ ุงูุจูุช ูุนูู ุงูุขู 24 ุณุงุนุฉ ุนูู ุงูุณูุฑูุฑ!");

// ุฏุงูุฉ ูุชุณุฌูู ุงูุฏุฎูู ูุงูุฎุฑูุฌ
function logLoginLogout(type) {
  const logFile = 'login_logout_log.txt';
  const now = new Date().toISOString();
  fs.appendFileSync(logFile, `${type},${now}\n`, 'utf8');
}

// ุชุณุฌูู ุงูุฏุฎูู
logLoginLogout('login');

// ูุญุงูู ุชุญููู ุงูุฌูุณุฉ ูู ููู
let stringSession = new StringSession("");

if (fs.existsSync("session.txt")) {
  const savedSession = fs.readFileSync("session.txt", "utf8");
  stringSession = new StringSession(savedSession.trim());
}

(async () => {
  console.log("๐ฒ ุจุฏุก ุงูุงุชุตุงู ุจุชููุฌุฑุงู...");
  const client = new TelegramClient(stringSession, apiId, apiHash, {
    connectionRetries: 5,
  });

  // ุชุณุฌูู ุงูุฏุฎูู ุนูุฏ ุงูุญุงุฌุฉ ููุท
  try {
    await client.start({
      phoneNumber: async () => PHONE_NUMBER,
      password: async () => PASSWORD,
      phoneCode: async () => PHONE_CODE,
      onError: (err) => console.log("โ ุฎุทุฃ:", err),
    });
  } catch (err) {
    if (err.errorMessage === 'AUTH_KEY_DUPLICATED') {
      console.error('โ AUTH_KEY_DUPLICATED: ุณูุชู ุญุฐู ุงูุฌูุณุฉ ุงููุฏููุฉ ูุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ.');
      fs.unlinkSync('session.txt'); // ุญุฐู ููู ุงูุฌูุณุฉ ุงููุฏููุฉ
      stringSession = new StringSession(""); // ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุณุฉ
      await client.start({
        phoneNumber: async () => PHONE_NUMBER,
        password: async () => PASSWORD,
        phoneCode: async () => PHONE_CODE,
        onError: (err) => console.log("โ ุฎุทุฃ:", err),
      });
    } else {
      throw err; // ุฅุนุงุฏุฉ ุฑูู ุงูุฎุทุฃ ุฅุฐุง ูู ููู AUTH_KEY_DUPLICATED
    }
  }

  console.log("โ ุชู ุชุณุฌูู ุงูุฏุฎูู!");
  const sessionString = client.session.save();

  // ุญูุธ ุงูุฌูุณุฉ ููุงุณุชุฎุฏุงู ุงูุชุงูู
  fs.writeFileSync("session.txt", sessionString);
  console.log("๐พ ุชู ุญูุธ ุงูุฌูุณุฉ ูู session.txt");

  await client.sendMessage("me", { message: "๐ ุจูุช ุงูุฅุดุนุงุฑุงุช ุดุบุงู!" });

  // ุชุญูู ูู ุงูุงูุถูุงู ููุจูุชุงุช ุงููุทููุจุฉ ูุฑุฉ ูุงุญุฏุฉ ููุท ูู ุงูุญูุงุฉ
  const joinedBotsFile = 'joined_bots.txt';
  if (!fs.existsSync(joinedBotsFile)) {
    try {
      // ูุงุฆูุฉ ุงูุจูุชุงุช ุงููุทููุจุฉ
      const botsToJoin = ['GMGN_sol_bot', 'solBigamout'];
      for (const bot of botsToJoin) {
        // ุฃุฑุณู ููุท ููุจูุชุงุช ุงูุชู ุชูุชูู ุจู _bot
        if (bot.endsWith('_bot')) {
          await client.sendMessage(bot, { message: '/start' });
          await sleep(2000);
        } else {
          console.log(`โ๏ธ ุชุฎุทู ${bot}: ููุณ ุจูุช ุชููุฌุฑุงู.`);
        }
      }
      fs.writeFileSync(joinedBotsFile, 'done');
      console.log('โ ุชู ุงูุงูุถูุงู ููู ุงูุจูุชุงุช ุงููุทููุจุฉ ูุฃูู ูุฑุฉ.');
    } catch (err) {
      console.error('โ ุฎุทุฃ ุฃุซูุงุก ุงูุงูุถูุงู ููุจูุชุงุช:', err.message);
    }
  }

  // ุงูุชุชุจุน ูุงูุชูุฌูู
  client.addEventHandler(async (update) => {
    try {
      // ุชุนุฏูู ุดุฑูุท ุงูููุชุฑุฉ ูุฅุถุงูุฉ ุงููุฑุฒ ุงูุฑุงุจุน
      if (update.message && typeof update.message.message === "string") {
        const msg = update.message;
        const text = msg.message;

        // ููุชุฑุฉ ุงูุฑุณุงุฆู ุงูุชู ุชุญุชูู ุนูู "counts: 1" ุฃู ุฃูุซุฑ ู"60 SOL" ุฃู ุฃูุซุฑ
        if (/\bcounts:\s*(\d+)\b/i.test(text) && parseInt(text.match(/\bcounts:\s*(\d+)\b/i)[1]) >= 1 &&
            /([6-9]\d|\d{3,})\.\d{2}\s*SOL(\D|$)/.test(text)) {

          // ููุชุฑุฉ "5m" ุจุญูุซ ุชููู ุจูู 0% ู 2000%
          const fiveMinMatch = text.match(/5m\s*\((\d+\.\d+)%\)/);
          if (fiveMinMatch) {
            const fiveMinPercentage = parseFloat(fiveMinMatch[1]);
            if (fiveMinPercentage > 2000) {
              console.log(`โ๏ธ ุงููุณุจุฉ 5m (${fiveMinPercentage}%) ุฃูุจุฑ ูู 2000%. ุชุฎุทู.`);
              return;
            }
          }

          // ุงููุฑุฒ ุงูุฑุงุจุน: ุงูุชุญูู ูู ุฃู ุนุฏุฏ ุงูุฃูุงู (d) ูุณุงูู 0
          const ageMatch = text.match(/age:\s*(\d+)d\s*(\d+)h/);
          if (ageMatch) {
            const days = parseInt(ageMatch[1]);
            if (days !== 0) {
              console.log(`โ๏ธ ุนุฏุฏ ุงูุฃูุงู (d) ููุณ 0. ุชุฎุทู.`);
              return;
            }
          }

          const startTime = performance.now();
          // ุงุณุชุฎุฑุงุฌ ุงูุชููู ุจุนุฏ ca:
          const caMatch = text.match(/ca:\s*([\w]+)/);
          if (caMatch && caMatch[1]) {
            const token = caMatch[1];
            if (sentTokens.has(token)) {
              console.log(`โ๏ธ ุงูุชููู ${token} ุชู ุฅุฑุณุงูู ูุณุจููุง. ุชุฎุทู.`);
              return;
            }
            // ุทุจุงุนุฉ ุงูุชููู ููุท ุจุฏูู ca:
            console.log(token);
            // ุญูุธ ุงูุชููู ูู ููู ูุงุณุชุฎุฏุงูู ูู ุจูุช sniperoo
            fs.writeFileSync('last_token.txt', token, 'utf8');

            // ุฅุฑุณุงู ุงูุชููู ููุนุฑูุฉ ุงูุณุนุฑ ูุจู ุงูุดุฑุงุก
            await client.sendMessage(botUsername, { message: token });
            console.log('๐ฉ ุชู ุฅุฑุณุงู ุงูุชูููู ููุนุฑูุฉ ุงูุณุนุฑ ูุจู ุงูุดุฑุงุก.');

            // ุฅุฑุณุงู ุฃูุฑ ุงูุดุฑุงุก ุงููุจุงุดุฑ
            const buyMsg = `/buy ${token} ${buyPrice}`;
            await client.sendMessage(botUsername, { message: buyMsg });
            console.log('โ ุชู ุฅุฑุณุงู ุฃูุฑ ุงูุดุฑุงุก ุงููุจุงุดุฑ:', buyMsg);

            // ุฅุถุงูุฉ ุงูุชููู ุฅูู ุงููุงุฆูุฉ ุงููุฑุณูุฉ
            sentTokens.add(token);
            fs.appendFileSync(sentTokensFile, `${token}\n`, 'utf8');

            const endTime = performance.now();
            const executionTimeLog = `โฑ๏ธ ููุช ุงูุชูููุฐ ููุชููู ${token}: ${(endTime - startTime).toFixed(2)} ูููู ุซุงููุฉ.`;
            console.log(executionTimeLog);
            executionLogsBuffer.push(`${executionTimeLog}\n`);
          }
        }
      }
    } catch (err) {
      console.error("โ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุฌูู:", err.message);
    }
  });
})();

const botUsername = 'GMGN_sol_bot';

// ุฏุงูุฉ ุงูุชุฏุงูู ุงูุชููุงุฆู ูู ุจูุช GMGN
async function tradeInGMGNBot(client, token) {
  const lastStartFile = 'gmgn_last_start.txt';
  let shouldSendStart = true;
  try {
    // ุชุญูู ูู ุขุฎุฑ ุฅุฑุณุงู ูู /start
    if (fs.existsSync(lastStartFile)) {
      const lastStartDate = fs.readFileSync(lastStartFile, 'utf8').trim();
      const today = new Date().toISOString().slice(0, 10);
      if (lastStartDate === today) {
        shouldSendStart = false;
      }
    }
    // ุฅุฑุณุงู /start ูุฑุฉ ูุงุญุฏุฉ ููุท ููููุงู
    if (shouldSendStart) {
      await client.sendMessage(botUsername, { message: '/start' });
      fs.writeFileSync(lastStartFile, new Date().toISOString().slice(0, 10));
      await sleep(2000);
    }
    // ุฅุฑุณุงู ุงูุชููู
    await client.sendMessage(botUsername, { message: token });
    await sleep(3000);

    // ุงุณุชูุจุงู ุฑุณุงุฆู ุงูุจูุช ูุทุจุงุนุฉ ูู ุฑุณุงูุฉ ูุงูุจุญุซ ุนู ุงูุณุนุฑ
    let price = null;
    let done = false;
    let lastBotMessage = null;
    const handler = async (update) => {
      // ุชุญูู ูู ุฃู ุงูุฑุณุงูุฉ ูู ุจูุช GMGN ุจูุงุกู ุนูู ุงุณู ุงููุณุชุฎุฏู ุฃู peerId
      if (update.message && update.message.peerId && (
            (update.message.peerId.userId && update.message.peerId.userId.toString().includes('GMGN')) ||
            (update.message.peerId.channelId && botUsername.includes('GMGN'))
          )) {
        const text = update.message.message;
        lastBotMessage = text;
        // ุชุญูู ุฃู ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ุงูุชููู ุงููุทููุจ
        if (text.includes(token)) {
          // ุงุณุชุฎุฑุงุฌ ุงูุณุนุฑ ูู ุงูุฑุณุงูุฉ
          let priceMatch = text.match(/price:\s*\$?([\d\.]+)/i);
          if (priceMatch && priceMatch[1]) {
            price = parseFloat(priceMatch[1]);
            done = true;
            // ุทุจุงุนุฉ ุงูุณุนุฑ ููุท ุจุฏูู ุจุงูู ุงูุฑุณุงูุฉ ูุจุฏูู ุนูุงูุฉ ุงูุฏููุงุฑ
            console.log('๐ฉ ุงูุณุนุฑ ูู GMGN: ' + priceMatch[1]);
            // ุญุณุงุจ ุงูุณุนุฑ ุงูุฌุฏูุฏ ุจุฒูุงุฏุฉ 1000%
            const newPrice = (price * 10).toFixed(6);
            // ุฅุฑุณุงู ุฃูุฑ ุงูุชุฏุงูู ูุจุงุดุฑุฉ
            const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
            await client.sendMessage(botUsername, { message: orderMsg });
            console.log('โ ุชู ุฅุฑุณุงู ุฃูุฑ ุงูุชุฏุงูู:', orderMsg);
          } else {
            // ุฅุฐุง ูู ููุฌุฏ ุณุนุฑุ ุงุทุจุน ุงูุฑุณุงูุฉ ูุงููุฉ
            console.log('๐ฉ ุฑุณุงูุฉ ูู GMGN:\n' + text);
          }
        }
      }
    };
    client.addEventHandler(handler);
    // ุงูุชุธุฑ ุญุชู ูุชู ุงุณุชูุจุงู ุงูุณุนุฑ ุฃู ุงูุชูุงุก ุงููููุฉ
    let tries = 0;
    while (!done && tries < 10) {
      await sleep(1000);
      tries++;
    }
    client.removeEventHandler(handler);
    if (!price) {
      console.log('๐ฉ ุฑุฏ ุงูุจูุช ุจุนุฏ ุงุฑุณุงู ุงูุชููู:\n' + (lastBotMessage || 'ูู ูุชู ุงุณุชูุจุงู ุฃู ุฑุณุงูุฉ ูู ุงูุจูุช ุจุนุฏ ุฅุฑุณุงู ุงูุชููู'));
      return;
    }
    // ุญุณุงุจ ุงูุณุนุฑ ุงูุฌุฏูุฏ ุจุฒูุงุฏุฉ 1000%
    const newPrice = (price * 10).toFixed(6);
    // ุฅุฑุณุงู ุฃูุฑ ุงูุชุฏุงูู
    const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
    await client.sendMessage(botUsername, { message: orderMsg });
    console.log('โ ุชู ุฅุฑุณุงู ุฃูุฑ ุงูุชุฏุงูู:', orderMsg);
  } catch (err) {
    console.error('โ ุฎุทุฃ ูู ุงูุชุฏุงูู ูุน GMGN:', err.message);
  }
}

// ุฏุงูุฉ ุชุฃุฎูุฑ ุจุณูุทุฉ
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

let buyPrice = 0.5; // ุงูุณุนุฑ ุงูุงูุชุฑุงุถู

const PORT = process.env.PORT || 3000;
http.createServer((req, res) => {
  if (req.method === "POST" && req.url === "/delete-all") {
    // ูุณุญ ูุญุชููุงุช ููู ุงูุณุฌูุงุช
    fs.writeFileSync('execution_logs.txt', '', 'utf8');
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <div style='text-align:center;'>
        <div style='font-size:2em;'>๐ ุชู ูุณุญ ุฌููุน ุงูุณุฌูุงุช ุจูุฌุงุญ!</div>
        <a href="/" style='font-size:1.5em; color:#0078D7;'>ุงูุนูุฏุฉ ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
      </div>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/update-price") {
    let body = "";
    req.on("data", chunk => {
      body += chunk.toString();
    });
    req.on("end", () => {
      const params = new URLSearchParams(body);
      const newPrice = parseFloat(params.get("price"));
      if (!isNaN(newPrice) && newPrice > 0) {
        buyPrice = newPrice;
        res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em;'>โ ุชู ุชุญุฏูุซ ุงูุณุนุฑ ุจูุฌุงุญ ุฅูู: ${buyPrice}</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>ุงูุนูุฏุฉ ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
          </div>
        `);
      } else {
        res.writeHead(400, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em; color:red;'>โ ุงูุณุนุฑ ุงููุฏุฎู ุบูุฑ ุตุงูุญ!</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>ุงูุนูุฏุฉ ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
          </div>
        `);
      }
    });
    return;
  }

  // ุญุณุงุจ ุนุฏุฏ ูุฑุงุช ุงูุฏุฎูู ูุงูุฎุฑูุฌ ุฎูุงู ุขุฎุฑ 24 ุณุงุนุฉ
  let count = 0;
  let executionLogs = '';
  try {
    const logFile = 'login_logout_log.txt';
    if (fs.existsSync(logFile)) {
      const logs = fs.readFileSync(logFile, 'utf8').split('\n').filter(Boolean);
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;
      count = logs.filter(line => {
        const [, time] = line.split(',');
        return now - new Date(time).getTime() <= oneDay;
      }).length;
    }

    // ูุฑุงุกุฉ ุงูุณุฌูุงุช ุงูุฎุงุตุฉ ุจููุช ุงูุชูููุฐ
    const executionLogFile = 'execution_logs.txt';
    if (fs.existsSync(executionLogFile)) {
      executionLogs = fs.readFileSync(executionLogFile, 'utf8');
    }
  } catch {}
  res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
  res.end(`
    <div style='text-align:center;'>
      <div style='font-size:2em;'>๐ ุงูุจูุช ูุนูู ุงูุขู 24 ุณุงุนุฉ ุนูู ุงูุณูุฑูุฑ!</div>
      <div style='margin-top:20px; font-size:1.5em;'>
        <form method="POST" action="/update-price">
          <label for="price" style='font-size:1.2em;'>ุชุญุฏูุซ ุณุนุฑ ุงูุดุฑุงุก:</label>
          <input type="number" step="0.0001" name="price" id="price" value="${buyPrice}" style='font-size:1.2em; margin:10px;' required />
          <button type="submit" style='font-size:1.2em; color:white; background-color:green; padding:5px 15px; border:none; cursor:pointer;'>ุชุญุฏูุซ</button>
        </form>
      </div>
      <div style='margin-top:20px; font-size:3em; color:#0078D7; font-weight:bold;'>ุนุฏุฏ ูุฑุงุช ุชุณุฌูู ุงูุฏุฎูู ูุงูุฎุฑูุฌ ุฎูุงู 24 ุณุงุนุฉ: ${count}</div>
      <div style='margin-top:20px; font-size:1.5em; color:#333;'>
        <h3>ุณุฌูุงุช ููุช ุงูุชูููุฐ:</h3>
        <pre style='text-align:left;'>${executionLogs}</pre>
      </div>
      <form method="POST" action="/delete-all" style='margin-top:20px;'>
        <button type="submit" style='font-size:1.5em; color:white; background-color:red; padding:10px 20px; border:none; cursor:pointer;'>Delete All</button>
      </form>
    </div>
  `);
}).listen(PORT, () => {
  console.log(`๐ HTTP Server running on port ${PORT}`);
});

const KEEP_ALIVE_URL = "https://cdcd.onrender.com/";
setInterval(() => {
  https.get(KEEP_ALIVE_URL, (res) => {
    console.log(`๐ Keep Alive Ping: ${KEEP_ALIVE_URL} - Status: ${res.statusCode}`);
  }).on("error", (e) => {
    console.error(`โ Keep Alive Error: ${e.message}`);
  });
}, 10 * 60 * 1000); // ูู 10 ุฏูุงุฆู

// ุชุณุฌูู ุงูุฎุฑูุฌ ุนูุฏ ุฅููุงุก ุงูุนูููุฉ
process.on('exit', () => {
  logLoginLogout('logout');
});
process.on('SIGINT', () => {
  logLoginLogout('logout');
  process.exit();
});

const sentTokensFile = 'sent_tokens.txt';
let sentTokens = new Set();
if (fs.existsSync(sentTokensFile)) {
  const tokens = fs.readFileSync(sentTokensFile, 'utf8').split('\n').filter(Boolean);
  sentTokens = new Set(tokens);
}

// ุชุญุณูู ุงูุฃุฏุงุก ุนุจุฑ ุชูููู ุนูููุงุช ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ (I/O) ูุงููุชุงุจุฉ ุงููุฌูุนุฉ
const executionLogsBuffer = [];

// ูุชุงุจุฉ ุงูุณุฌูุงุช ุงููุฌูุนุฉ ุฅูู ุงูููู ุจุดูู ุฏูุฑู
setInterval(() => {
  if (executionLogsBuffer.length > 0) {
    fs.appendFileSync('execution_logs.txt', executionLogsBuffer.join(''), 'utf8');
    executionLogsBuffer.length = 0;
  }
}, 5000); // ูู 5 ุซูุงูู

