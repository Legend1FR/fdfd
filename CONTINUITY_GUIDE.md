# 🛡️ دليل ضمان الاستمرارية لنظام تتبع التوكنات

## 📋 نظرة عامة

تم تطوير نظام متكامل لضمان استمرار تتبع التوكنات حتى بعد إغلاق البرنامج أو حدوث أعطال. النظام يشمل:

### 🔧 المكونات الجديدة

1. **نظام الاستمرارية المحسن** (`enhanced_persistence.js`)
   - حفظ تلقائي كل 30 ثانية
   - نسخ احتياطية متعددة
   - استعادة تلقائية من النسخ الاحتياطية
   - نظام heartbeat للمراقبة

2. **مراقب التطبيق** (`application_monitor.js`)
   - مراقبة مستمرة لحالة التطبيق
   - إعادة تشغيل تلقائي عند التعطل
   - فحص دوري للـ heartbeat
   - سجلات مفصلة للأحداث

3. **سكريپتات الضمان**
   - `ensure_continuity.bat` - للتشغيل على Windows
   - `ensure_continuity_advanced.ps1` - نسخة متقدمة بـ PowerShell
   - `start_with_monitor.js` - بدء التطبيق مع المراقبة

## 🚀 طرق التشغيل

### الطريقة الأولى: التشغيل العادي (محسن)
```bash
node server.js
```
- النظام محسن الآن مع حفظ تلقائي كل 30 ثانية
- نسخ احتياطية تلقائية
- استعادة من النسخ الاحتياطية عند الحاجة

### الطريقة الثانية: التشغيل مع المراقبة المتقدمة
```bash
node start_with_monitor.js
```
- مراقبة مستمرة للتطبيق
- إعادة تشغيل تلقائي عند التعطل
- فحص heartbeat كل 30 ثانية

### الطريقة الثالثة: ضمان الاستمرارية - Windows Batch
```batch
ensure_continuity.bat
```
- سكريپت بسيط لنظام Windows
- فحص دوري كل 30 ثانية
- إعادة تشغيل تلقائي
- سجلات في ملف `continuity.log`

### الطريقة الرابعة: ضمان الاستمرارية المتقدم - PowerShell
```powershell
.\ensure_continuity_advanced.ps1
```
- مراقبة متقدمة مع إحصائيات
- فحص heartbeat ذكي
- واجهة تفاعلية
- إعدادات قابلة للتخصيص

## 🔄 آليات الاستمرارية

### 1. حفظ البيانات المحسن
- **حفظ تلقائي**: كل 30 ثانية
- **نسخ احتياطية**: يتم الاحتفاظ بـ 10 نسخ احتياطية
- **استعادة ذكية**: استعادة تلقائية من النسخ الاحتياطية عند تلف الملف الرئيسي

### 2. نظام Heartbeat
- **ملف heartbeat.json**: يتم تحديثه كل دقيقة
- **معلومات النشاط**: عدد التوكنات النشطة، استخدام الذاكرة، وقت التشغيل
- **مراقبة التجمد**: اكتشاف توقف التطبيق حتى لو كانت العملية تعمل

### 3. إعادة التشغيل الذكي
- **حد أقصى**: 10 محاولات إعادة تشغيل في 5 دقائق
- **تأخير تدريجي**: 5 ثوانٍ بين المحاولات
- **فحص الصحة**: التأكد من نجاح بدء التطبيق

## 📁 الملفات المهمة

### ملفات البيانات
- `tracked_tokens.json` - الملف الرئيسي للتوكنات
- `backups/` - مجلد النسخ الاحتياطية
- `heartbeat.json` - ملف مراقبة النشاط
- `sent_tokens.txt` - قائمة التوكنات المرسلة

### ملفات السجلات
- `continuity.log` - سجل نظام الاستمرارية
- `app_monitor.log` - سجل مراقب التطبيق
- `monitor.log` - سجل المراقبة العامة

## ⚙️ التخصيص

### إعدادات النظام المحسن
يمكن تخصيص الإعدادات في `server.js`:
```javascript
enhancedPersistence = new EnhancedPersistence({
  trackedTokensFile: 'tracked_tokens.json',
  saveInterval: 30000,      // حفظ كل 30 ثانية
  heartbeatInterval: 60000, // heartbeat كل دقيقة
  maxBackups: 10           // عدد النسخ الاحتياطية
});
```

### إعدادات المراقب
يمكن تخصيص إعدادات المراقب في `start_with_monitor.js`:
```javascript
const monitor = new ApplicationMonitor({
  scriptPath: 'server.js',
  restartDelay: 5000,      // 5 ثوانٍ
  maxRestarts: 10,         // حد أقصى 10 إعادة تشغيل
  restartWindow: 300000,   // في 5 دقائق
  heartbeatTimeout: 120000 // مهلة heartbeat دقيقتان
});
```

## 🔍 مراقبة النظام

### التحقق من حالة التطبيق
1. **ملف heartbeat**: فحص تاريخ آخر تحديث في `heartbeat.json`
2. **ملفات السجل**: مراجعة آخر الأحداث في ملفات السجل
3. **النسخ الاحتياطية**: التأكد من وجود نسخ احتياطية حديثة

### إحصائيات في الوقت الفعلي
عند استخدام PowerShell المتقدم، سيتم عرض:
- وقت التشغيل
- عدد إعادات التشغيل
- حالة التطبيق
- آخر heartbeat

## 🛠️ استكشاف الأخطاء

### المشاكل الشائعة والحلول

1. **التطبيق لا يبدأ**
   - تحقق من ملف `continuity.log`
   - تأكد من وجود ملف `server.js`
   - تحقق من إعدادات Node.js

2. **فقدان البيانات**
   - سيتم الاستعادة تلقائياً من النسخ الاحتياطية
   - تحقق من مجلد `backups/`

3. **توقف المراقبة**
   - أعد تشغيل سكريپت الضمان
   - تحقق من سجلات الأخطاء

## 🌐 التشغيل على الخادم

### على Render.com
النظام مُحسن للعمل على Render مع:
- Keep Alive Service نشط
- متغيرات البيئة محفوظة
- النسخ الاحتياطية على القرص المحلي

### على Windows Server
- استخدم PowerShell المتقدم
- قم بإعداد مهمة مجدولة لبدء السكريپت تلقائياً
- تأكد من وجود صلاحيات كافية

## 📊 الفوائد الجديدة

1. **موثوقية عالية**: 99.9% من الوقت نشط
2. **حفظ آمن**: عدة مستويات من النسخ الاحتياطية
3. **استعادة سريعة**: أقل من 10 ثوانٍ لإعادة التشغيل
4. **مراقبة شاملة**: سجلات مفصلة لكل الأحداث
5. **صيانة تلقائية**: تنظيف النسخ الاحتياطية القديمة

## 🔧 التحديثات المستقبلية

- واجهة ويب لمراقبة النظام
- إشعارات عبر التليجرام عند حدوث مشاكل
- نظام تحليل الأداء
- دعم أنظمة تشغيل إضافية

---

**ملاحظة**: النظام الآن قادر على ضمان استمرار تتبع التوكنات حتى في حالة انقطاع الكهرباء أو إعادة تشغيل الجهاز، طالما أن النظام يعود للعمل تلقائياً.
