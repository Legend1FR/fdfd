const { TelegramClient } = require("telegram");
const { StringSession } = require("telegram/sessions");
const fs = require("fs");
const input = require("input");
const http = require("http");
const https = require("https");

const { performance } = require('perf_hooks');
const puppeteer = require('puppeteer');
// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
const trackedTokens = {};

// Ù…ØªØµÙØ­ Ù…Ø´ØªØ±Ùƒ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
let sharedBrowser = null;

// Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
const MAX_TRACKED_TOKENS = 100;

// Ù…Ù„Ù Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø©
const trackedTokensFile = 'tracked_tokens.json';

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
async function getSharedBrowser() {
  if (sharedBrowser && sharedBrowser.isConnected()) {
    return sharedBrowser;
  }

  try {
    console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØµÙØ­ Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯...');
    const launchOptions = {
      headless: true, // ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ false Ù„ØªØ¬Ù†Ø¨ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙˆØª
      args: [
        '--no-sandbox', 
        '--disable-setuid-sandbox', 
        '--disable-blink-features=AutomationControlled',
        '--disable-web-security',
        '--disable-dev-shm-usage',
        '--no-first-run',
        '--disable-default-apps',
        '--disable-extensions',
        '--disable-infobars',
        '--disable-features=VizDisplayCompositor',
        '--window-size=1366,768',
        '--start-maximized',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding'
      ]
    };

    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Chrome Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù€ Windows
    const chromePaths = [
      'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
      'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe',
      process.env.PROGRAMFILES + '\\Google\\Chrome\\Application\\chrome.exe',
      process.env['PROGRAMFILES(X86)'] + '\\Google\\Chrome\\Application\\chrome.exe',
      process.env.PUPPETEER_EXECUTABLE_PATH
    ].filter(Boolean);

    let browserLaunched = false;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø§Ù„Ù…Ø«Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
    for (const chromePath of chromePaths) {
      try {
        if (fs.existsSync(chromePath)) {
          launchOptions.executablePath = chromePath;
          sharedBrowser = await puppeteer.launch(launchOptions);
          browserLaunched = true;
          console.log(`ğŸŒ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù†: ${chromePath}`);
          break;
        }
      } catch (err) {
        console.log(`âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø·Ù„Ø§Ù‚ Chrome Ù…Ù† ${chromePath}: ${err.message}`);
      }
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Puppeteer
    if (!browserLaunched) {
      try {
        delete launchOptions.executablePath;
        sharedBrowser = await puppeteer.launch(launchOptions);
        browserLaunched = true;
        console.log(`ğŸŒ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Puppeteer`);
      } catch (err) {
        console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ${err.message}`);
        throw err;
      }
    }

    return sharedBrowser;
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ:', error.message);
    sharedBrowser = null;
    throw error;
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ø£Ù…Ø§Ù†
async function closeSharedBrowser() {
  if (sharedBrowser) {
    try {
      console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ...');
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ø¹ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ©
      const pages = await Promise.race([
        sharedBrowser.pages(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout getting pages')), 3000))
      ]);
      
      for (const page of pages) {
        try {
          await Promise.race([
            page.close(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout closing page')), 2000))
          ]);
        } catch (err) {
          // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª
        }
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ©
      await Promise.race([
        sharedBrowser.close(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout closing browser')), 5000))
      ]);
      
      console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
      sharedBrowser = null;
    } catch (error) {
      console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­:', error.message);
      // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù‚Ø³Ø±ÙŠ
      try {
        const process = sharedBrowser.process();
        if (process && !process.killed) {
          process.kill('SIGKILL');
          console.log('âš¡ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø³Ø±ÙŠØ§Ù‹');
        }
      } catch (killError) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØªØµÙØ­:', killError.message);
      }
      sharedBrowser = null;
    }
  }
}

// Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø© Ø¥Ù„Ù‰ Ù…Ù„Ù
function saveTrackedTokens() {
  try {
    const tokensToSave = {};
    Object.keys(trackedTokens).forEach(token => {
      const t = trackedTokens[token];
      tokensToSave[token] = {
        token: t.token,
        startTime: t.startTime,
        firstPrice: t.firstPrice,
        lastPrice: t.lastPrice,
        maxIncrease: t.maxIncrease,
        reached50: t.reached50,
        stopped: t.stopped,
        browserFailed: t.browserFailed,
        manualMode: t.manualMode,
        rugcheckStatus: t.rugcheckStatus, // Ø¥Ø¶Ø§ÙØ© Ø­ÙØ¸ Ø­Ø§Ù„Ø© rugcheck
        // Ø¥Ø¶Ø§ÙØ© Ø­ÙØ¸ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        previousHighPrice: t.previousHighPrice,
        currentHighPrice: t.currentHighPrice,
        lastRiseTime: t.lastRiseTime,
        rapidRiseAchieved: t.rapidRiseAchieved,
        priceRiseHistory: t.priceRiseHistory || [] // ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ©
        // Ù„Ø§ Ù†Ø­ÙØ¸ page Ù„Ø£Ù†Ù‡Ø§ ÙƒØ§Ø¦Ù†Ø§Øª ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ³Ù„Ø³Ù„
      };
    });
    fs.writeFileSync(trackedTokensFile, JSON.stringify(tokensToSave, null, 2), 'utf8');
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø©:', error.message);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø© Ù…Ù† Ù…Ù„Ù
function loadTrackedTokens() {
  try {
    if (fs.existsSync(trackedTokensFile)) {
      const savedTokens = JSON.parse(fs.readFileSync(trackedTokensFile, 'utf8'));
      Object.keys(savedTokens).forEach(token => {
        const savedToken = savedTokens[token];
        trackedTokens[token] = {
          ...savedToken,
          startTime: new Date(savedToken.startTime), // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† string Ø¥Ù„Ù‰ Date
          page: null,
          rugcheckStatus: savedToken.rugcheckStatus || null, // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© rugcheck Ø£Ùˆ ØªØ¹ÙŠÙŠÙ† null Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          previousHighPrice: savedToken.previousHighPrice || null,
          currentHighPrice: savedToken.currentHighPrice || null,
          lastRiseTime: savedToken.lastRiseTime ? new Date(savedToken.lastRiseTime) : null,
          rapidRiseAchieved: savedToken.rapidRiseAchieved || false,
          priceRiseHistory: savedToken.priceRiseHistory || [] // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ©
        };
      });
      console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${Object.keys(savedTokens).length} ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸`);
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙˆÙ‚Ù
      Object.keys(trackedTokens).forEach(token => {
        const t = trackedTokens[token];
        if (!t.stopped && !t.browserFailed) {
          console.log(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ†: ${token}`);
          startPuppeteerTracking(token, t.startTime).catch(err => {
            console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${err.message}`);
            startManualTracking(token);
          });
        }
      });
    }
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø©:', error.message);
  }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz
async function checkTokenSafety(token) {
  let page = null;
  try {
    const browser = await getSharedBrowser();
    page = await browser.newPage();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ user-agent Ø­Ù‚ÙŠÙ‚ÙŠ
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…ØªØºÙŠØ±Ø§Øª ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØªÙ…ØªØ©
    await page.evaluateOnNewDocument(() => {
      Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
      Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
      Object.defineProperty(navigator, 'languages', { get: () => ['en-US', 'en'] });
    });
    
    const rugcheckUrl = `https://rugcheck.xyz/tokens/${token}`;
    console.log(`[${token}] ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz...`);
    
    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© rugcheck
    await page.goto(rugcheckUrl, { 
      waitUntil: 'domcontentloaded', 
      timeout: 30000 
    });
    
    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    await new Promise(resolve => setTimeout(resolve, 5000));
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ†
    let tokenStatus = null;
    
    try {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØªÙŠ ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Good Ø£Ùˆ Danger
      const pageText = await page.evaluate(() => document.body.innerText.toLowerCase());
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
      if (pageText.includes('danger') || pageText.includes('high risk')) {
        tokenStatus = 'DANGER';
      } else if (pageText.includes('warning') || pageText.includes('medium risk') || pageText.includes('caution')) {
        tokenStatus = 'WARNING';
      } else if (pageText.includes('good') || pageText.includes('green') || pageText.includes('safe') || pageText.includes('low risk')) {
        tokenStatus = 'GOOD';
      }
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
      if (!tokenStatus) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†Ø§ØµØ± Ø¨Ø£Ù„ÙˆØ§Ù† Ø£Ùˆ ÙØ¦Ø§Øª ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
        const dangerElements = await page.$$eval('*', elements => {
          return elements.some(el => {
            const style = window.getComputedStyle(el);
            const text = el.textContent.toLowerCase();
            const className = el.className.toLowerCase();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "danger"
            return (style.color.includes('rgb(255') && style.color.includes('0') && style.color.includes('0')) ||
                   (style.backgroundColor.includes('rgb(255') && style.backgroundColor.includes('0') && style.backgroundColor.includes('0')) ||
                   className.includes('danger') ||
                   className.includes('red') ||
                   text.includes('danger') ||
                   text.includes('high risk');
          });
        });
        
        const warningElements = await page.$$eval('*', elements => {
          return elements.some(el => {
            const style = window.getComputedStyle(el);
            const text = el.textContent.toLowerCase();
            const className = el.className.toLowerCase();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ±Ø§Ø¡/Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ© Ø£Ùˆ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "warning"
            return (style.color.includes('rgb(255') && style.color.includes('255') && style.color.includes('0')) ||
                   (style.color.includes('rgb(255') && style.color.includes('165') && style.color.includes('0')) ||
                   (style.backgroundColor.includes('rgb(255') && style.backgroundColor.includes('255') && style.backgroundColor.includes('0')) ||
                   (style.backgroundColor.includes('rgb(255') && style.backgroundColor.includes('165') && style.backgroundColor.includes('0')) ||
                   className.includes('warning') ||
                   className.includes('yellow') ||
                   className.includes('orange') ||
                   text.includes('warning') ||
                   text.includes('medium risk') ||
                   text.includes('caution');
          });
        });
        
        const goodElements = await page.$$eval('*', elements => {
          return elements.some(el => {
            const style = window.getComputedStyle(el);
            const text = el.textContent.toLowerCase();
            const className = el.className.toLowerCase();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "good"
            return (style.color.includes('rgb(0') && style.color.includes('255') && style.color.includes('0')) ||
                   (style.backgroundColor.includes('rgb(0') && style.backgroundColor.includes('255') && style.backgroundColor.includes('0')) ||
                   className.includes('good') ||
                   className.includes('green') ||
                   className.includes('safe') ||
                   text.includes('good') ||
                   text.includes('safe') ||
                   text.includes('low risk');
          });
        });
        
        if (dangerElements) {
          tokenStatus = 'DANGER';
        } else if (warningElements) {
          tokenStatus = 'WARNING';
        } else if (goodElements) {
          tokenStatus = 'GOOD';
        }
      }
    } catch (evaluateError) {
      console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ ØªÙ‚ÙŠÙŠÙ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©: ${evaluateError.message}`);
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    await page.close();
    
    console.log(`[${token}] âœ… Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ†: ${tokenStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
    return tokenStatus;
    
  } catch (error) {
    console.error(`[${token}] âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† rugcheck.xyz: ${error.message}`);
    if (page && !page.isClosed()) {
      await page.close();
    }
    return null; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø¹ØªØ¨Ø± Ø£Ù† Ø§Ù„ØªØ­Ù‚Ù‚ ÙØ´Ù„
  }
}

// Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙˆÙƒÙ† Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† puppeteer)
async function startTrackingToken(token, rugcheckStatus = null) {
  if (trackedTokens[token]) {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙÙ‚Ø· Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© rugcheck
    if (rugcheckStatus !== null) {
      trackedTokens[token].rugcheckStatus = rugcheckStatus;
      saveTrackedTokens();
    }
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
  const activeTokensCount = Object.keys(trackedTokens).filter(t => !trackedTokens[t].stopped).length;
  if (activeTokensCount >= MAX_TRACKED_TOKENS) {
    console.log(`âš ï¸ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (${MAX_TRACKED_TOKENS}). ØªØ®Ø·ÙŠ Ø§Ù„ØªÙˆÙƒÙ†: ${token}`);
    return;
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙˆØ±Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ù…ØªØµÙØ­
  const startTime = new Date();
  trackedTokens[token] = {
    token,
    startTime,
    firstPrice: null,
    lastPrice: null,
    maxIncrease: 0,
    reached50: false,
    stopped: false,
    page: null,
    browserFailed: false,
    manualMode: false, // ÙˆØ¶Ø¹ ÙŠØ¯ÙˆÙŠ Ø¨Ø¯ÙˆÙ† puppeteer
    rugcheckStatus: rugcheckStatus, // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† rugcheck.xyz
    lowLiquidity: null, // Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: true = Ù…Ù†Ø®ÙØ¶Ø©ØŒ false = Ø·Ø¨ÙŠØ¹ÙŠØ©ØŒ null = ØºÙŠØ± Ù…Ø­Ù‚Ù‚Ø©
    // New feature: Price rise comparison
    previousHighPrice: null,
    currentHighPrice: null,
    lastRiseTime: null,
    rapidRiseAchieved: false,
    priceRiseHistory: [] // Array to store price rise events with timestamps
  };

  // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
  saveTrackedTokens();
  
  console.log(`[${token}] ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ù…Ù„Ù`);

  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… puppeteerØŒ ÙˆØ¥Ø°Ø§ ÙØ´Ù„ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ ÙŠØ¯ÙˆÙŠ
  try {
    await startPuppeteerTracking(token, startTime);
  } catch (error) {
    console.error(`[${token}] ÙØ´Ù„ PuppeteerØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ: ${error.message}`);
    startManualTracking(token);
  }
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ù€ Puppeteer
async function startPuppeteerTracking(token, startTime) {

  const url = `https://gmgn.ai/sol/token/${token}`;
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  let firstPrice = (trackedTokens[token] && trackedTokens[token].firstPrice && typeof trackedTokens[token].firstPrice === 'number') 
                   ? trackedTokens[token].firstPrice 
                   : null;
  let lastPrice = null;
  let maxIncrease = 0;
  let reached50 = false;
  let stopped = false;

  let browser;
  let page;
  
  try {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
    let retryCount = 0;
    const maxRetries = 3;
    
    while (retryCount < maxRetries) {
      try {
        browser = await getSharedBrowser();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…ØªØµÙ„ ÙˆÙŠØ¹Ù…Ù„
        if (!browser.isConnected()) {
          throw new Error('Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…ØªØµÙ„');
        }
        
        break; // Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­
      } catch (error) {
        retryCount++;
        console.log(`[${token}] Ù…Ø­Ø§ÙˆÙ„Ø© ${retryCount}/${maxRetries} Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ ÙØ´Ù„Øª: ${error.message}`);
        
        // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŒ Ø£Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡Ù‡
        if (sharedBrowser) {
          try {
            await closeSharedBrowser();
          } catch (closeError) {
            console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ${closeError.message}`);
          }
          sharedBrowser = null;
        }
        
        if (retryCount >= maxRetries) {
          console.error(`[${token}] ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¹Ø¯ ${maxRetries} Ù…Ø­Ø§ÙˆÙ„Ø§Øª`);
          // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ
          startManualTracking(token);
          return;
        }
        
        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        await new Promise(r => setTimeout(r, 2000));
      }
    }
    
    page = await browser.newPage();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„ØµÙØ­Ø©
    page.on('error', (error) => {
      console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©: ${error.message}`);
    });
    
    page.on('pageerror', (error) => {
      console.log(`[${token}] Ø®Ø·Ø£ JavaScript ÙÙŠ Ø§Ù„ØµÙØ­Ø©: ${error.message}`);
    });
    
    page.on('disconnect', () => {
      console.log(`[${token}] ØªÙ… Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙØ­Ø©`);
    });
    
    // ØªØ¹ÙŠÙŠÙ† user-agent Ø­Ù‚ÙŠÙ‚ÙŠ
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…ØªØºÙŠØ±Ø§Øª ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØªÙ…ØªØ©
    await page.evaluateOnNewDocument(() => {
      Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
      Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
      Object.defineProperty(navigator, 'languages', { get: () => ['en-US', 'en'] });
    });
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
    let navigationAttempts = 0;
    const maxNavigationAttempts = 3;
    let navigationSuccessful = false;
    
    while (navigationAttempts < maxNavigationAttempts && !navigationSuccessful) {
      try {
        navigationAttempts++;
        console.log(`[${token}] Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ ${navigationAttempts}/${maxNavigationAttempts} Ø¥Ù„Ù‰: ${url}`);
        
        // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„ØªÙ†Ù‚Ù„ Ù…Ø¹ Promise.race
        await Promise.race([
          page.goto(url, { 
            waitUntil: 'domcontentloaded', 
            timeout: 60000 // ØªÙ‚Ù„ÙŠÙ„ timeout Ø¥Ù„Ù‰ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
          }),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Navigation timeout after 60 seconds')), 60000)
          )
        ]);
        
        // Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        await new Promise(resolve => setTimeout(resolve, 5000)); // ØªÙ‚Ù„ÙŠÙ„ Ø¥Ù„Ù‰ 5 Ø«ÙˆØ§Ù†ÙŠ
        navigationSuccessful = true;
        console.log(`[${token}] ØªÙ… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${navigationAttempts}`);
        
      } catch (navError) {
        console.log(`[${token}] ÙØ´Ù„Øª Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ ${navigationAttempts}: ${navError.message}`);
        
        if (navigationAttempts >= maxNavigationAttempts) {
          throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¹Ø¯ ${maxNavigationAttempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${navError.message}`);
        }
        
        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
  } catch (error) {
    console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙØ­: ${error.message}`);
    if (page) await page.close();
    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙØ­
    startManualTracking(token);
    return;
  }

  // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ Ø³Ø¹Ø± ÙˆÙØ­Øµ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©
  async function getPrice() {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ù…ØªØµÙ„Ø©
      if (page.isClosed()) {
        console.log(`[${token}] Ø§Ù„ØµÙØ­Ø© Ù…ØºÙ„Ù‚Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±`);
        return null;
      }
      
      // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ù„ØµÙØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±
      await new Promise(resolve => setTimeout(resolve, 5000));
      
      // ÙØ­Øµ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© (Ø¨Ø­Ø« Ù…ÙˆØ³Ø¹)
      try {
        const bodyText = await page.evaluate(() => document.body.innerText);
        // Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ù„Ù„ØªØ­Ø°ÙŠØ±
        const liquidityWarnings = [
          "this token has low liquidity",
          "low liquidity",
          "no liquidity",
          "liquidity is low",
          "insufficient liquidity",
          "not enough liquidity",
          "Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©",
          "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠÙˆÙ„Ø©"
        ];
        let hasLowLiquidity = liquidityWarnings.some(warning => bodyText.toLowerCase().includes(warning));

        // Ø¨Ø­Ø« ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© Ø¹Ù† ÙƒÙ„Ù…Ø© liquidity ÙˆØªØ­Ø°ÙŠØ±Ø§Øª
        if (!hasLowLiquidity) {
          try {
            hasLowLiquidity = await page.evaluate(() => {
              const warnings = [
                "liquidity",
                "low liquidity",
                "no liquidity",
                "insufficient liquidity",
                "not enough liquidity",
                "Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©",
                "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠÙˆÙ„Ø©"
              ];
              // Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù† ÙƒÙ„Ù…Ø© ØªØ­Ø°ÙŠØ±
              return Array.from(document.querySelectorAll('*')).some(el => {
                const txt = (el.textContent || "").toLowerCase();
                return warnings.some(w => txt.includes(w));
              });
            });
          } catch {}
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© ÙÙŠ trackedTokens
        if (trackedTokens[token]) {
          const previousLiquidityStatus = trackedTokens[token].lowLiquidity;
          trackedTokens[token].lowLiquidity = hasLowLiquidity;
          
          // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø©
          if (previousLiquidityStatus !== hasLowLiquidity) {
            if (hasLowLiquidity) {
              console.log(`[${token}] âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø© Ù„Ù„ØªÙˆÙƒÙ† - Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©`);
              // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©
              trackedTokens[token].stopped = true;
              trackedTokens[token].lastPrice = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©";
              saveTrackedTokens();
              return null; // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±
            } else {
              console.log(`[${token}] âœ… ØªØ­Ø³Ù†Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„ØªÙˆÙƒÙ† - Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©`);
            }
          }
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ Ø£ÙˆÙ‚Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
          if (hasLowLiquidity && previousLiquidityStatus === null) {
            console.log(`[${token}] âš ï¸ Ø§Ù„ØªÙˆÙƒÙ† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø© - Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©`);
            trackedTokens[token].stopped = true;
            trackedTokens[token].lastPrice = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©";
            saveTrackedTokens();
            return null;
          }
        }
      } catch (liquidityError) {
        console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: ${liquidityError.message}`);
      }
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ù…Ù†ÙØµÙ„Ø§Ù‹
      try {
        await page.evaluate(() => document.title); // Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø§ØªØµØ§Ù„
      } catch (frameError) {
        console.log(`[${token}] Ø§Ù„Ø¥Ø·Ø§Ø± Ù…Ù†ÙØµÙ„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ù‚Ù„...`);
        
        try {
          // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
          await page.close();
          page = await browser.newPage();
          
          // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„ØªØ¬Ù†Ø¨ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙˆØª
          await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
          await page.setViewport({ width: 1366, height: 768 });
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙƒØ§ÙØ­Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙˆØª
          await page.evaluateOnNewDocument(() => {
            Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
            Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });
            Object.defineProperty(navigator, 'languages', { get: () => ['en-US', 'en'] });
            Object.defineProperty(navigator, 'permissions', { get: () => ({ query: () => Promise.resolve({ state: 'granted' }) }) });
          });
          
          // ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ù‚Ù„
          await new Promise(resolve => setTimeout(resolve, Math.random() * 3000 + 2000));
          
          await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });
          console.log(`[${token}] ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­`);
          
          // Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„
          await new Promise(resolve => setTimeout(resolve, 5000));
          
        } catch (retryError) {
          console.log(`[${token}] ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ù‚Ù„: ${retryError.message}`);
          return null;
        }
      }
      
      // Ø¬Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø³Ù„ÙƒØªÙˆØ± .price Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
      try {
        console.log(`[${token}] Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† selector .price...`);
        await page.waitForSelector('.price', { timeout: 30000 }); // Ø²ÙŠØ§Ø¯Ø© timeout
        const priceText = await page.$eval('.price', el => el.textContent);
        console.log(`[${token}] Ù†Øµ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø®Ø§Ù…: "${priceText}"`);
        const price = parseFloat(priceText.replace(/[^\d.eE\-+]/g, ''));
        if (!isNaN(price) && price > 0) {
          console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† .price:`, price);
          return price;
        }
      } catch (e) {
        console.log(`[${token}] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ .price Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£:`, e.message);
      }
    } catch (e) {
      console.log(`[${token}] Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±:`, e.message);
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† selectors Ø£Ø®Ø±Ù‰ Ø´Ø§Ø¦Ø¹Ø© Ù„Ù„Ø£Ø³Ø¹Ø§Ø±
    console.log(`[${token}] Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… selectors Ø¨Ø¯ÙŠÙ„Ø©...`);
    const priceSelectors = [
      '[data-testid="price"]',
      '.token-price', 
      '.current-price',
      '.price-value',
      '[class*="price"]',
      '[id*="price"]',
      '.price',
      '[data-price]',
      '.token-info .price',
      '.price-display'
    ];
    
    for (const selector of priceSelectors) {
      try {
        const element = await page.$(selector);
        if (element) {
          const priceText = await page.evaluate(el => el.textContent || el.innerText, element);
          console.log(`[${token}] Ù†Øµ Ù…Ù† ${selector}: "${priceText}"`);
          const price = parseFloat(priceText.replace(/[^\d.eE\-+]/g, ''));
          if (!isNaN(price) && price > 0) {
            console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† ${selector}:`, price);
            return price;
          }
        }
      } catch (e) {
        // ØªØ¬Ø§Ù‡Ù„ ÙˆØªØ§Ø¨Ø¹ Ù…Ø¹ Ø§Ù„Ø³Ù„ÙƒØªÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ
      }
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
    try {
      const title = await page.title();
      const titlePriceMatch = title.match(/\$([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)/);
      if (titlePriceMatch && titlePriceMatch[1]) {
        const priceValue = parseFloat(titlePriceMatch[1]);
        if (!isNaN(priceValue) && priceValue > 0.0000001 && priceValue < 100) {
          console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${priceValue}`);
          return priceValue;
        }
      }
    } catch (e) {
      // ØªØ¬Ø§Ù‡Ù„
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ù…Ù„ Ø§Ù„Ø³Ù„ÙƒØªÙˆØ±Ø²ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©
    try {
      const bodyText = await page.evaluate(() => document.body.innerText);
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø³ÙŠØ§Ù‚ ÙˆØ§Ø¶Ø­ ÙÙ‚Ø· Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµØºÙŠØ±Ø©
      const contextualPricePatterns = [
        /price[:\s]*\$([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)/gi,
        /current[:\s]*\$([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)/gi,
        /\$([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)\s*USD/gi,
        /USD[:\s]*([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)/gi
      ];
      
      for (const pattern of contextualPricePatterns) {
        const matches = bodyText.matchAll(pattern);
        for (const match of matches) {
          const priceValue = parseFloat(match[1]);
          // ÙÙ„ØªØ± Ø¥Ø¶Ø§ÙÙŠ: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
          if (!isNaN(priceValue) && priceValue > 0 && priceValue < 1000000) {
            console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¹Ø¨Ø± pattern contextual: ${priceValue}`);
            return priceValue;
          }
        }
      }
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø®Ø§ØµØ© Ù…Ø«Ù„ â‚… (subscript 5)
      const smallPricePatterns = [
        /\$0\.0â‚…([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚…30829
        /\$0\.0â‚„([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚„12345  
        /\$0\.0â‚ƒ([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚ƒ56789
        /\$0\.0â‚†([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚†98765
        /\$0\.0â‚‡([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚‡45678
        /\$0\.0â‚ˆ([0-9]+)/g, // Ù…Ø«Ù„ $0.0â‚ˆ12309
        /\$0\.0â‚‰([0-9]+)/g  // Ù…Ø«Ù„ $0.0â‚‰87654
      ];
      
      for (const pattern of smallPricePatterns) {
        const matches = bodyText.matchAll(pattern);
        for (const match of matches) {
          const digits = match[1];
          let priceValue;
          
          // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (pattern.source.includes('â‚…')) {
            priceValue = parseFloat(`0.00000${digits}`); // 5 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚„')) {
            priceValue = parseFloat(`0.0000${digits}`); // 4 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚ƒ')) {
            priceValue = parseFloat(`0.000${digits}`); // 3 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚†')) {
            priceValue = parseFloat(`0.000000${digits}`); // 6 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚‡')) {
            priceValue = parseFloat(`0.0000000${digits}`); // 7 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚ˆ')) {
            priceValue = parseFloat(`0.00000000${digits}`); // 8 Ø£ØµÙØ§Ø±
          } else if (pattern.source.includes('â‚‰')) {
            priceValue = parseFloat(`0.000000000${digits}`); // 9 Ø£ØµÙØ§Ø±
          }
          
          if (!isNaN(priceValue) && priceValue > 0) {
            console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØºÙŠØ±: ${priceValue} Ù…Ù† Ø§Ù„Ù†Øµ: ${match[0]}`);
            return priceValue;
          }
        }
      }
      
      // ÙƒØ­Ù„ Ø£Ø®ÙŠØ±: Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ù†Ø·Ù‚ÙŠ Ø¨Ø´Ø±Ø· Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…Ø¹Ù‚ÙˆÙ„
      const generalPricePattern = /\$([0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?)/g;
      const matches = bodyText.matchAll(generalPricePattern);
      for (const match of matches) {
        const priceValue = parseFloat(match[1]);
        // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…Ø¹Ù‚ÙˆÙ„ Ù„Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø´ÙØ±Ø© Ø§Ù„ØµØºÙŠØ±Ø©
        if (!isNaN(priceValue) && priceValue > 0.0000001 && priceValue < 100) {
          console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¹Ø¨Ø± pattern Ø¹Ø§Ù…: ${priceValue}`);
          return priceValue;
        }
      }
      
      // Ø§Ø·Ø¨Ø¹ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
      console.log(`[${token}] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©: "${await page.title()}"`);
      console.log(`[${token}] Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙØ­Ø©:\n`, bodyText.slice(0, 800));
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
      const dollarMatches = bodyText.match(/\$[0-9.,eE\-+]+/g);
      if (dollarMatches) {
        console.log(`[${token}] Ù†ØµÙˆØµ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ $:`, dollarMatches.slice(0, 10));
      }
    } catch (e) {
      console.log(`[${token}] Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù†Øµ Ø§Ù„ØµÙØ­Ø©:`, e.message);
    }
    
    // Ø¥Ø°Ø§ ÙØ´Ù„ PuppeteerØŒ Ø¬Ø±Ø¨ Ø·Ø±ÙŠÙ‚Ø© API Ù…Ø¨Ø§Ø´Ø±Ø©
    console.log(`[${token}] ÙØ´Ù„ PuppeteerØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù…Ø¨Ø§Ø´Ø±...`);
    try {
      const https = require('https');
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø¹Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†
      const apiOptions = {
        hostname: 'api.dexscreener.com',
        port: 443,
        path: `/latest/dex/tokens/${token}`,
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
          'Accept': 'application/json',
        }
      };
      
      const apiPrice = await new Promise((resolve, reject) => {
        const req = https.request(apiOptions, (res) => {
          let data = '';
          res.on('data', (chunk) => { data += chunk; });
          res.on('end', () => {
            try {
              const jsonData = JSON.parse(data);
              if (jsonData.pairs && jsonData.pairs.length > 0) {
                const price = parseFloat(jsonData.pairs[0].priceUsd);
                if (!isNaN(price) && price > 0) {
                  console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† API: ${price}`);
                  resolve(price);
                } else {
                  resolve(null);
                }
              } else {
                resolve(null);
              }
            } catch (parseError) {
              console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ JSON Ù…Ù† API: ${parseError.message}`);
              resolve(null);
            }
          });
        });
        
        req.on('error', (error) => {
          console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ API: ${error.message}`);
          resolve(null);
        });
        
        req.setTimeout(10000, () => {
          console.log(`[${token}] Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ API`);
          req.abort();
          resolve(null);
        });
        
        req.end();
      });
      
      if (apiPrice) {
        console.log(`[${token}] Ù†Ø¬Ø­ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† API: ${apiPrice}`);
        return apiPrice;
      }
    } catch (apiError) {
      console.log(`[${token}] ÙØ´Ù„ ÙÙŠ API request: ${apiError.message}`);
    }
    
    return null;
  }

  // ÙƒØ±Ø± Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„ Ø­ØªÙ‰ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­ÙÙˆØ¸Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹)
  let priceAttempts = 0;
  const maxPriceAttempts = 3; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ù„Ù‰ 3
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
  if (firstPrice !== null) {
    console.log(`[${token}] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹: ${firstPrice}`);
  } else {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ†Ø§ Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹
    while (firstPrice === null && priceAttempts < maxPriceAttempts) {
      try {
        console.log(`[${token}] Ù…Ø­Ø§ÙˆÙ„Ø© ${priceAttempts + 1}/${maxPriceAttempts} Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±...`);
        firstPrice = await getPrice();
        if (firstPrice === null) {
          priceAttempts++;
          if (priceAttempts < maxPriceAttempts) {
            await new Promise(r => setTimeout(r, 5000)); // Ø§Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†Ù ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
          }
        }
      } catch (error) {
        priceAttempts++;
        console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ${priceAttempts}: ${error.message}`);
        await new Promise(r => setTimeout(r, 3000));
      }
    }
  }

  if (firstPrice === null) {
    console.error(`[${token}] ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ ${maxPriceAttempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.`);
    if (browser) await browser.close();
    trackedTokens[token].browserFailed = true;
    trackedTokens[token].firstPrice = "ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±";
    trackedTokens[token].lastPrice = "ØºÙŠØ± Ù…ØªØ§Ø­";
    saveTrackedTokens();
    return;
  }
  // ØªØ¹ÙŠÙŠÙ† lastPrice Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  if (trackedTokens[token] && trackedTokens[token].lastPrice && typeof trackedTokens[token].lastPrice === 'number') {
    lastPrice = trackedTokens[token].lastPrice;
  } else {
    lastPrice = firstPrice;
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ trackedTokens
  if (trackedTokens[token]) {
    // ØªØ­Ø¯ÙŠØ« firstPrice ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„
    if (!trackedTokens[token].firstPrice || typeof trackedTokens[token].firstPrice !== 'number') {
      trackedTokens[token].firstPrice = firstPrice;
    }
    // ØªØ­Ø¯ÙŠØ« lastPrice ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø£Ùˆ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (!trackedTokens[token].lastPrice || typeof trackedTokens[token].lastPrice !== 'number' || lastPrice > trackedTokens[token].lastPrice) {
      trackedTokens[token].lastPrice = lastPrice;
    }
    // Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…ØªØµÙØ­ (Ù„Ø£Ù†Ù‡ Ù…Ø´ØªØ±Ùƒ)
    trackedTokens[token].page = page;
    saveTrackedTokens();
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
  (async function updateLoop() {
    while (trackedTokens[token] && !trackedTokens[token].stopped) {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ù…Ø§ Ø²Ø§Ù„Øª Ù…ØªØµÙ„Ø©
        if (page.isClosed() || !browser.isConnected()) {
          console.log(`[${token}] Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…ØºÙ„Ù‚ØŒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©`);
          break;
        }
        
        const price = await getPrice();
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙˆÙ„Ù… ÙŠÙØ­Ø°Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        if (!trackedTokens[token]) break;
        
        if (price) {
          // ØªØ­Ø¯ÙŠØ« lastPrice ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          if (price > trackedTokens[token].lastPrice) {
            // New feature: Track price rise comparison
            const currentTime = new Date();
            const previousPrice = trackedTokens[token].lastPrice;
            
            // Check if this is a significant price increase (10% or more)
            const priceIncreasePercent = ((price - previousPrice) / previousPrice) * 100;
            
            if (priceIncreasePercent >= 10) {
              // Store the previous high price if not already set
              if (trackedTokens[token].previousHighPrice === null) {
                trackedTokens[token].previousHighPrice = previousPrice;
              }
              
              // Update current high price
              trackedTokens[token].currentHighPrice = price;
              
              // Calculate time difference from last rise
              let timeDifference = null;
              if (trackedTokens[token].lastRiseTime) {
                timeDifference = (currentTime - trackedTokens[token].lastRiseTime) / 1000 / 60; // in minutes
              }
              
              // Check if rise happened in less than 2 minutes
              if (timeDifference === null || timeDifference < 2) {
                trackedTokens[token].rapidRiseAchieved = true;
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ priceRiseHistory Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡
                if (!trackedTokens[token].priceRiseHistory) {
                  trackedTokens[token].priceRiseHistory = [];
                }
                trackedTokens[token].priceRiseHistory.push({
                  fromPrice: previousPrice,
                  toPrice: price,
                  increasePercent: priceIncreasePercent,
                  timestamp: currentTime,
                  timeDifference: timeDifference,
                  isRapid: true
                });
              } else {
                // Add to history but mark as not rapid
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ priceRiseHistory Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡
                if (!trackedTokens[token].priceRiseHistory) {
                  trackedTokens[token].priceRiseHistory = [];
                }
                trackedTokens[token].priceRiseHistory.push({
                  fromPrice: previousPrice,
                  toPrice: price,
                  increasePercent: priceIncreasePercent,
                  timestamp: currentTime,
                  timeDifference: timeDifference,
                  isRapid: false
                });
              }
              
              trackedTokens[token].lastRiseTime = currentTime;
            }
            
            trackedTokens[token].lastPrice = price;
          }
          // Ù„Ø§ ØªØºÙŠØ± firstPrice Ø¨Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ†Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø©
          const increase = ((price - trackedTokens[token].firstPrice) / trackedTokens[token].firstPrice) * 100;
          if (increase > trackedTokens[token].maxIncrease) trackedTokens[token].maxIncrease = increase;
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠØµÙ„ Ø¨Ø¹Ø¯ Ø¥Ù„Ù‰ 50% ÙˆØ­Ù‚Ù‚Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŒ Ø«Ø¨Ù‘Øª reached50 Ø¹Ù„Ù‰ true
          if (!trackedTokens[token].reached50 && increase >= 50) {
            trackedTokens[token].reached50 = true;
          }
          
          // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
          const now = Date.now();
          if (!trackedTokens[token].lastSave || now - trackedTokens[token].lastSave > 60000) {
            trackedTokens[token].lastSave = now;
            saveTrackedTokens();
          }
        }
      } catch (error) {
        console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${error.message}`);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù†ØªØ¸Ø± ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        await new Promise(r => setTimeout(r, 30000)); // Ø§Ù†ØªØ¸Ø§Ø± 30 Ø«Ø§Ù†ÙŠØ©
        continue;
      }
      
      await new Promise(r => setTimeout(r, 10000));
    }
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
    if (page && !page.isClosed()) {
      await page.close().catch(err => {
        console.log(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©: ${err.message}`);
      });
    }
  })();
}

// Helper function to check rapid rise conditions
function checkRapidRiseCondition(token, currentPrice, previousPrice, currentTime) {
  if (!trackedTokens[token]) return false;
  
  const priceIncreasePercent = ((currentPrice - previousPrice) / previousPrice) * 100;
  
  // Check if price increased by 10% or more
  if (priceIncreasePercent >= 10) {
    const timeDifference = trackedTokens[token].lastRiseTime 
      ? (currentTime - trackedTokens[token].lastRiseTime) / 1000 / 60 // in minutes
      : null;
    
    // If rise happened in less than 2 minutes, it's considered rapid
    if (timeDifference === null || timeDifference < 2) {
      return true;
    }
  }
  
  return false;
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© ÙŠØ¯ÙˆÙŠØ© Ø¨Ø¯ÙˆÙ† puppeteer (Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTP requests)
function startManualTracking(token) {
  if (!trackedTokens[token]) return;
  
  trackedTokens[token].manualMode = true;
  trackedTokens[token].firstPrice = "ÙˆØ¶Ø¹ ÙŠØ¯ÙˆÙŠ - ØºÙŠØ± Ù…ØªØ§Ø­";
  trackedTokens[token].lastPrice = "ÙŠØªØ·Ù„Ø¨ Chrome";
  trackedTokens[token].rugcheckStatus = null; // Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  // Initialize new properties for manual mode
  trackedTokens[token].previousHighPrice = null;
  trackedTokens[token].currentHighPrice = null;
  trackedTokens[token].lastRiseTime = null;
  trackedTokens[token].rapidRiseAchieved = false;
  trackedTokens[token].priceRiseHistory = [];
  
  // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
  saveTrackedTokens();
  
  console.log(`[${token}] Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¨Ø¯ÙˆÙ† Puppeteer)`);
  console.log(`[${token}] Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØª Chrome: npx puppeteer browsers install chrome`);
}

// Ø­Ø°Ù Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
function stopTrackingToken(token) {
  if (trackedTokens[token]) {
    trackedTokens[token].stopped = true;
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© (ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
    if (trackedTokens[token].page) {
      trackedTokens[token].page.close().catch(err => {
        console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©: ${err.message}`);
      });
    }
    delete trackedTokens[token];
    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    saveTrackedTokens();
    console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙˆÙƒÙ† ${token} Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©`);
  }
}

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø³ÙŠØ±ÙØ±
const PHONE_NUMBER = "+967xxxxxxxxx";  // Ø¶Ø¹ Ø±Ù‚Ù…Ùƒ Ù‡Ù†Ø§
const PASSWORD = "YOUR_PASSWORD"; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 2FA
const PHONE_CODE = undefined; // ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ undefined Ù„ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡

const apiId = 23299626;
const apiHash = "89de50a19288ec535e8b008ae2ff268d";

console.log("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±!");

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Chrome Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
function cleanupChromeProcesses() {
  try {
    const { exec } = require('child_process');
    // Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ§Øª Chrome Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù„Ù‰ Windows
    exec('taskkill /f /im chrome.exe /t', (error, stdout, stderr) => {
      if (!error) {
        console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¹Ù…Ù„ÙŠØ§Øª Chrome Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©');
      }
    });
  } catch (error) {
    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  }
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
cleanupChromeProcesses();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
async function initializeSharedBrowser() {
  try {
    await getSharedBrowser();
    console.log('âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
  } catch (error) {
    console.error('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø´ØªØ±Ùƒ:', error.message);
    console.log('ğŸ“± Ø³ÙŠØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙÙ‚Ø·');
  }
}

// ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØµÙØ­ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª
initializeSharedBrowser().then(() => {
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØµÙØ­
  loadTrackedTokens();
}).catch(err => {
  console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', err.message);
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ù…ØªØµÙØ­
  loadTrackedTokens();
});

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
function logLoginLogout(type) {
  const logFile = 'login_logout_log.txt';
  const now = new Date().toISOString();
  fs.appendFileSync(logFile, `${type},${now}\n`, 'utf8');
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
logLoginLogout('login');

// Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ù…Ù„Ù
let stringSession = new StringSession("");

if (fs.existsSync("session.txt")) {
  const savedSession = fs.readFileSync("session.txt", "utf8");
  stringSession = new StringSession(savedSession.trim());
}

(async () => {
  console.log("ğŸ“² Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙ„ÙŠØ¬Ø±Ø§Ù…...");
  const client = new TelegramClient(stringSession, apiId, apiHash, {
    connectionRetries: 5,
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·
  try {
    await client.start({
      phoneNumber: async () => PHONE_NUMBER,
      password: async () => PASSWORD,
      phoneCode: async () => PHONE_CODE,
      onError: (err) => console.log("âŒ Ø®Ø·Ø£:", err),
    });
  } catch (err) {
    if (err.errorMessage === 'AUTH_KEY_DUPLICATED') {
      console.error('âŒ AUTH_KEY_DUPLICATED: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©.');
      fs.unlinkSync('session.txt'); // Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      stringSession = new StringSession(""); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©
      await client.start({
        phoneNumber: async () => PHONE_NUMBER,
        password: async () => PASSWORD,
        phoneCode: async () => PHONE_CODE,
        onError: (err) => console.log("âŒ Ø®Ø·Ø£:", err),
      });
    } else {
      throw err; // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† AUTH_KEY_DUPLICATED
    }
  }

  console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
  const sessionString = client.session.save();

  // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠ
  fs.writeFileSync("session.txt", sessionString);
  console.log("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ session.txt");

  await client.sendMessage("me", { message: "ğŸš€ Ø¨ÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø´ØºØ§Ù„!" });

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø­ÙŠØ§Ø©
  const joinedBotsFile = 'joined_bots.txt';
  if (!fs.existsSync(joinedBotsFile)) {
    try {
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      const botsToJoin = ['GMGN_sol_bot', 'solBigamout'];
      for (const bot of botsToJoin) {
        // Ø£Ø±Ø³Ù„ ÙÙ‚Ø· Ù„Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€ _bot
        if (bot.endsWith('_bot')) {
          await client.sendMessage(bot, { message: '/start' });
          await sleep(2000);
        } else {
          console.log(`âš ï¸ ØªØ®Ø·ÙŠ ${bot}: Ù„ÙŠØ³ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù….`);
        }
      }
      fs.writeFileSync(joinedBotsFile, 'done');
      console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.');
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨ÙˆØªØ§Øª:', err.message);
    }
  }

  // Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
  client.addEventHandler(async (update) => {
    try {
      // ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø² Ø§Ù„Ø±Ø§Ø¨Ø¹
      if (update.message && typeof update.message.message === "string") {
        const msg = update.message;
        const text = msg.message;

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "counts: 1" Ø£Ùˆ Ø£ÙƒØ«Ø± Ùˆ"25 SOL" Ø£Ùˆ Ø£ÙƒØ«Ø±
        if (/\bcounts:\s*(\d+)\b/i.test(text) && parseInt(text.match(/\bcounts:\s*(\d+)\b/i)[1]) >= 1 &&
            /(2[5-9]|[3-9]\d|\d{3,})\.\d{2}\s*SOL(\D|$)/.test(text)) {

          // ÙÙ„ØªØ±Ø© "5m" Ø¨Ø­ÙŠØ« ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0% Ùˆ 3000%
          const fiveMinMatch = text.match(/5m\s*\((\d+\.\d+)%\)/);
          if (fiveMinMatch) {
            const fiveMinPercentage = parseFloat(fiveMinMatch[1]);
            if (fiveMinPercentage > 3000) {
              console.log(`âš ï¸ Ø§Ù„Ù†Ø³Ø¨Ø© 5m (${fiveMinPercentage}%) Ø£ÙƒØ¨Ø± Ù…Ù† 3000%. ØªØ®Ø·ÙŠ.`);
              return;
            }
          }

          // Ø§Ù„ÙØ±Ø² Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (d) ÙŠØ³Ø§ÙˆÙŠ 0
          const ageMatch = text.match(/age:\s*(\d+)d\s*(\d+)h/);
          if (ageMatch) {
            const days = parseInt(ageMatch[1]);
            if (days !== 0) {
              console.log(`âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (d) Ù„ÙŠØ³ 0. ØªØ®Ø·ÙŠ.`);
              return;
            }
          }

          // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¹Ø± price: $... ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 0.01
          const priceMatch = text.match(/price:\s*\$?([\deE\.-]+)/i);
          if (priceMatch && priceMatch[1]) {
            let priceValue = parseFloat(priceMatch[1]);
            if (isNaN(priceValue)) {
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØµÙŠØºØ© Ø¹Ù„Ù…ÙŠØ©
              try {
                priceValue = Number(priceMatch[1]);
              } catch {}
            }
            if (!(priceValue < 0.01)) {
              console.log(`âš ï¸ Ø§Ù„Ø³Ø¹Ø± ${priceValue} Ø£ÙƒØ¨Ø± Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ 0.01. ØªØ®Ø·ÙŠ.`);
              return;
            }
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø±ØŒ ØªØ®Ø·Ù‰
            console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ØªØ®Ø·ÙŠ.');
            return;
          }

          const startTime = performance.now();
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ø¹Ø¯ ca:
          const caMatch = text.match(/ca:\s*([\w]+)/);
          if (caMatch && caMatch[1]) {
            const token = caMatch[1];
            if (sentTokens.has(token)) {
              console.log(`âš ï¸ Ø§Ù„ØªÙˆÙƒÙ† ${token} ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§. ØªØ®Ø·ÙŠ.`);
              return;
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙˆÙƒÙ† ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ca:
            console.log(token);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            console.log(`[${token}] ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz...`);
            const tokenSafety = await checkTokenSafety(token);
            
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© rugcheck ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø­Ù‚Ø§Ù‹
            if (trackedTokens[token]) {
              trackedTokens[token].rugcheckStatus = tokenSafety;
            }
            
            if (tokenSafety === 'DANGER') {
              console.log(`[${token}] âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªÙˆÙƒÙ† - Ù…ØµÙ†Ù ÙƒÙ€ DANGER Ø¹Ù„Ù‰ rugcheck.xyz`);
              console.log(`[${token}] ğŸš« Ù„Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ GMGN`);
              
              // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø±ÙØ¶Ù‡ (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
              startTrackingToken(token, tokenSafety).catch(err => {
                console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${err.message}`);
              });
              
              return; // Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø·Ø±
            } else if (tokenSafety === 'WARNING') {
              console.log(`[${token}] âš ï¸ ØªØ­Ø°ÙŠØ± - Ø§Ù„ØªÙˆÙƒÙ† Ù…ØµÙ†Ù ÙƒÙ€ WARNING Ø¹Ù„Ù‰ rugcheck.xyz`);
              console.log(`[${token}] ğŸ¤” Ù„Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙƒØ¥Ø¬Ø±Ø§Ø¡ Ø§Ø­ØªØ±Ø§Ø²ÙŠ`);
              
              // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø±ÙØ¶Ù‡ (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
              startTrackingToken(token, tokenSafety).catch(err => {
                console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${err.message}`);
              });
              
              return; // Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ­Ø°ÙŠØ±
            } else if (tokenSafety === 'GOOD') {
              console.log(`[${token}] âœ… Ø§Ù„ØªÙˆÙƒÙ† Ø¢Ù…Ù† - Ù…ØµÙ†Ù ÙƒÙ€ GOOD Ø¹Ù„Ù‰ rugcheck.xyz`);
              console.log(`[${token}] ğŸš€ Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ GMGN`);
            } else {
              console.log(`[${token}] âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz (Ø±Ø¨Ù…Ø§ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚)`);
              console.log(`[${token}] ğŸ¤” Ø³ÙŠØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø­Ø°Ø±...`);
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…Ù„Ù Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¨ÙˆØª sniperoo
            fs.writeFileSync('last_token.txt', token, 'utf8');

            // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø¢Ù…Ù† (GOOD) Ø£Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯ (Ù„ÙŠØ³ DANGER Ø£Ùˆ WARNING)
            if (tokenSafety !== 'DANGER' && tokenSafety !== 'WARNING') {
              // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù„Ø­Ø¸Ø© (Ø²Ù…Ù† Ø¨Ù„Ø§Ù†Ùƒ)
              const buyMsg = `/buy ${token} ${buyPrice}`;
              client.sendMessage(botUsername, { message: buyMsg });
              client.sendMessage(botUsername, { message: token });
              console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', buyMsg);
              console.log('ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡.');

              // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©
              sentTokens.add(token);
              fs.appendFileSync(sentTokensFile, `${token}\n`, 'utf8');

              // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ† (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
              startTrackingToken(token, tokenSafety).catch(err => {
                console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${err.message}`);
              });
            } else {
              console.log(`[${token}] ğŸ›‘ ØªÙ… ØªØ®Ø·ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ø³Ø¨Ø¨ ØªØµÙ†ÙŠÙÙ‡ ÙƒÙ€ ${tokenSafety} Ø¹Ù„Ù‰ rugcheck.xyz`);
              
              // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ† Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø±ÙØ¶Ù‡ (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª) Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
              startTrackingToken(token, tokenSafety).catch(err => {
                console.error(`[${token}] Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${err.message}`);
              });
            }

            const endTime = performance.now();
            const executionTimeLog = `â±ï¸ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ù„ØªÙˆÙƒÙ† ${token}: ${(endTime - startTime).toFixed(2)} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©.`;
            console.log(executionTimeLog);
            executionLogsBuffer.push(`${executionTimeLog}\n`);
          }
        }
      }
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", err.message);
    }
  });
})();

const botUsername = 'GMGN_sol_bot';

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø¨ÙˆØª GMGN
async function tradeInGMGNBot(client, token) {
  const lastStartFile = 'gmgn_last_start.txt';
  let shouldSendStart = true;
  try {
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ /start
    if (fs.existsSync(lastStartFile)) {
      const lastStartDate = fs.readFileSync(lastStartFile, 'utf8').trim();
      const today = new Date().toISOString().slice(0, 10);
      if (lastStartDate === today) {
        shouldSendStart = false;
      }
    }
    // Ø¥Ø±Ø³Ø§Ù„ /start Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙŠÙˆÙ…ÙŠØ§Ù‹
    if (shouldSendStart) {
      await client.sendMessage(botUsername, { message: '/start' });
      fs.writeFileSync(lastStartFile, new Date().toISOString().slice(0, 10));
      await sleep(2000);
    }
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†
    await client.sendMessage(botUsername, { message: token });
    await sleep(3000);

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª ÙˆØ·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±
    let price = null;
    let done = false;
    let lastBotMessage = null;
    const handler = async (update) => {
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø¨ÙˆØª GMGN Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ peerId
      if (update.message && update.message.peerId && (
            (update.message.peerId.userId && update.message.peerId.userId.toString().includes('GMGN')) ||
            (update.message.peerId.channelId && botUsername.includes('GMGN'))
          )) {
        const text = update.message.message;
        lastBotMessage = text;
        // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        if (text.includes(token)) {
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          let priceMatch = text.match(/price:\s*\$?([\d\.]+)/i);
          if (priceMatch && priceMatch[1]) {
            price = parseFloat(priceMatch[1]);
            done = true;
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
            console.log('ğŸ“© Ø§Ù„Ø³Ø¹Ø± Ù…Ù† GMGN: ' + priceMatch[1]);
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø²ÙŠØ§Ø¯Ø© 1000%
            const newPrice = (price * 10).toFixed(6);
            // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
            const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
            await client.sendMessage(botUsername, { message: orderMsg });
            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„:', orderMsg);
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø±ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø©
            console.log('ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† GMGN:\n' + text);
          }
        }
      }
    };
    client.addEventHandler(handler);
    // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©
    let tries = 0;
    while (!done && tries < 10) {
      await sleep(1000);
      tries++;
    }
    client.removeEventHandler(handler);
    if (!price) {
      console.log('ğŸ“© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†:\n' + (lastBotMessage || 'Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†'));
      return;
    }
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø²ÙŠØ§Ø¯Ø© 1000%
    const newPrice = (price * 10).toFixed(6);
    // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
    await client.sendMessage(botUsername, { message: orderMsg });
    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„:', orderMsg);
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¹ GMGN:', err.message);
  }
}

// Ø¯Ø§Ù„Ø© ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·Ø©
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

let buyPrice = 0.5; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

const PORT = process.env.PORT || 1010;
const server = http.createServer((req, res) => {
  // Health check endpoint Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Render
  if (req.method === "GET" && req.url === "/health") {
    res.writeHead(200, { "Content-Type": "application/json" });
    res.end(JSON.stringify({ status: "OK", timestamp: new Date().toISOString() }));
    return;
  }

  // Root endpoint Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
  if (req.method === "GET" && req.url === "/") {
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <div style='text-align:center; font-family: Arial, sans-serif; padding: 50px;'>
        <h1 style='color: #0078D7;'>ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h1>
        <p style='font-size: 1.2em; color: #333;'>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${new Date().toLocaleString('ar-SA')}</p>
        <p><a href="/track_token" style='color: #0078D7; text-decoration: none;'>ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª</a></p>
      </div>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/delete-all") {
    // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    fs.writeFileSync('execution_logs.txt', '', 'utf8');
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <div style='text-align:center;'>
        <div style='font-size:2em;'>ğŸš€ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!</div>
        <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/update-price") {
    let body = "";
    req.on("data", chunk => {
      body += chunk.toString();
    });
    req.on("end", () => {
      const params = new URLSearchParams(body);
      const newPrice = parseFloat(params.get("price"));
      if (!isNaN(newPrice) && newPrice > 0) {
        buyPrice = newPrice;
        res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em;'>âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${buyPrice}</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
        `);
      } else {
        res.writeHead(400, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em; color:red;'>âŒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¯Ø®Ù„ ØºÙŠØ± ØµØ§Ù„Ø­!</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
        `);
      }
    });
    return;
  }

  // ...existing code...
  if (req.method === "GET" && req.url.startsWith("/track_token")) {
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <html lang="ar">
      <head>
        <title>Token Tracker</title>
        <meta http-equiv="refresh" content="10">
        <style>
          body { font-family: Tahoma, Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 0; direction: rtl; }
          h2 { text-align: center; color: #0078D7; margin-top: 30px; letter-spacing: 1px; }
          .tokens-container { max-width: 700px; margin: 30px auto; }
          .token-block {
            background: #fff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px #0001;
            padding: 18px 22px 12px 22px;
            margin-bottom: 18px;
            border-radius: 10px;
            transition: box-shadow 0.2s;
            position: relative;
          }
          .token-block:hover { box-shadow: 0 4px 16px #0002; }
          .token-label { color: #333; font-weight: bold; display: inline-block; min-width: 170px; }
          .token-value { color: #0078D7; font-weight: bold; }
          .token-status { font-size: 1.1em; }
          .delete-btn {
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 7px 18px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
          }
          .delete-btn:hover { background: #b71c1c; }
          .token-row { margin-bottom: 7px; }
        </style>
      </head>
      <body>
        <h2>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª (Token Tracker)</h2>
        <div style='text-align: center; margin-bottom: 20px; color: #666; font-size: 0.9em;'>
          ğŸ”„ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØªØ³ØªÙ…Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬<br/>
          ğŸ›¡ï¸ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ rugcheck.xyz: <span style="color: #4CAF50;">âœ… Ø¢Ù…Ù†</span> | <span style="color: #FF9800;">ğŸ”¶ ØªØ­Ø°ÙŠØ±</span> | <span style="color: #F44336;">âš ï¸ Ø®Ø·Ø±</span> | <span style="color: #666;">â“ ØºÙŠØ± Ù…Ø­Ù‚Ù‚</span><br/>
          ğŸ’§ ÙŠØªÙ… ÙØ­Øµ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù…Ù† gmgn.ai: <span style="color: #4CAF50;">âœ… Ø³ÙŠÙˆÙ„Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©</span> | <span style="color: #FF5722;">âš ï¸ Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©</span> | <span style="color: #666;">â“ ØºÙŠØ± Ù…Ø­Ù‚Ù‚Ø©</span><br/>
          ğŸš« <strong>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©</strong>
        </div>
        <div class="tokens-container">
        ${Object.values(trackedTokens)
          .sort((a, b) => b.startTime - a.startTime) // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
          .map(t => {
            let percent = '';
            let firstPriceDisplay = '';
            let lastPriceDisplay = '';
            let priceComparison = '';
            
            if (t.browserFailed) {
              firstPriceDisplay = 'âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­';
              lastPriceDisplay = 'âŒ ØºÙŠØ± Ù…ØªØ§Ø­';
              percent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
              priceComparison = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            } else if (t.firstPrice && t.lastPrice && typeof t.firstPrice === 'number' && typeof t.lastPrice === 'number') {
              const p = ((t.lastPrice - t.firstPrice) / t.firstPrice) * 100;
              percent = (p >= 0 ? '+' : '') + p.toFixed(2) + '%';
              firstPriceDisplay = t.firstPrice + '$';
              lastPriceDisplay = t.lastPrice + '$';
              
              // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙˆØ§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„
              const ratio = (t.lastPrice / t.firstPrice).toFixed(2);
              if (ratio >= 10) {
                priceComparison = `ğŸš€ Ø§Ø±ØªÙØ¹ ${ratio}x Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„`;
              } else if (ratio >= 5) {
                priceComparison = `ğŸ“ˆ Ø§Ø±ØªÙØ¹ ${ratio}x Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„`;
              } else if (ratio >= 2) {
                priceComparison = `â¬†ï¸ Ø§Ø±ØªÙØ¹ ${ratio}x Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„`;
              } else if (ratio > 1) {
                priceComparison = `ğŸ”¼ Ø§Ø±ØªÙØ¹ ${ratio}x Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„`;
              } else if (ratio == 1) {
                priceComparison = `â¡ï¸ Ù„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¹Ø±`;
              } else {
                priceComparison = `ğŸ”» Ø§Ù†Ø®ÙØ¶ Ø¥Ù„Ù‰ ${ratio}x Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„`;
              }
            } else if (t.firstPrice && typeof t.firstPrice === 'string') {
              firstPriceDisplay = t.firstPrice;
              lastPriceDisplay = t.lastPrice || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
              percent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
              priceComparison = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            } else {
              firstPriceDisplay = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
              lastPriceDisplay = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
              percent = '...';
              priceComparison = '...';
            }
            
            // Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© hh:mm:ss
            let duration = '...';
            if (t.startTime) {
              const ms = Date.now() - t.startTime.getTime();
              const totalSeconds = Math.floor(ms / 1000);
              const hours = Math.floor(totalSeconds / 3600);
              const minutes = Math.floor((totalSeconds % 3600) / 60);
              const seconds = totalSeconds % 60;
              duration = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            }
            
            const statusIcon = t.browserFailed ? 'âš ï¸' : t.stopped && t.lowLiquidity ? 'ğŸš«' : (t.reached50 ? 'âœ…ï¸' : 'âŒï¸');
            const statusText = t.browserFailed ? 'ÙØ´Ù„ Ø§Ù„Ù…ØªØµÙØ­' : t.stopped && t.lowLiquidity ? 'ØªÙˆÙ‚ÙØª - Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©' : (t.reached50 ? 'ÙˆØµÙ„ 50%+' : 'Ù„Ù… ÙŠØµÙ„ Ø¨Ø¹Ø¯');
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø©
            let liquidityIcon = 'ğŸ’§';
            let liquidityText = 'Ø·Ø¨ÙŠØ¹ÙŠØ©';
            let liquidityColor = '#4CAF50';
            
            if (t.lowLiquidity === true) {
              liquidityIcon = 'âš ï¸';
              liquidityText = 'Ù„Ù… ÙŠØ¹Ø¯ ÙŠÙˆØ¬Ø¯ Ø³ÙŠÙˆÙ„Ø© Ø£Ùˆ Ø³ÙŠÙˆÙ„Ø© Ø£ØµØ¨Ø­Øª Ù…Ù†Ø®ÙØ¶Ø©';
              liquidityColor = '#FF5722';
            } else if (t.lowLiquidity === false) {
              liquidityIcon = 'âœ…';
              liquidityText = 'Ø³ÙŠÙˆÙ„Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©';
              liquidityColor = '#4CAF50';
            } else {
              liquidityIcon = 'â“';
              liquidityText = 'ØºÙŠØ± Ù…Ø­Ù‚Ù‚Ø©';
              liquidityColor = '#666';
            }
            
            // New feature: Price rise comparison status
            let rapidRiseStatus = '';
            let rapidRiseIcon = '';
            if (t.rapidRiseAchieved) {
              rapidRiseIcon = 'âœ…';
              rapidRiseStatus = 'Ø­Ù‚Ù‚ Ø§Ø±ØªÙØ§Ø¹ Ø³Ø±ÙŠØ¹ 10%+ ÙÙŠ Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†';
            } else if (t.priceRiseHistory && t.priceRiseHistory.length > 0) {
              const hasSlowRise = t.priceRiseHistory.some(rise => rise.increasePercent >= 10 && !rise.isRapid);
              if (hasSlowRise) {
                rapidRiseIcon = 'â³';
                rapidRiseStatus = 'Ø§Ø±ØªÙØ¹ 10%+ Ù„ÙƒÙ† ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† - Ù„Ù… ÙŠÙØ­ØªØ³Ø¨';
              } else {
                rapidRiseIcon = 'â­•';
                rapidRiseStatus = 'Ù„Ù… ÙŠØ­Ù‚Ù‚ Ø§Ø±ØªÙØ§Ø¹ 10% Ø¨Ø¹Ø¯';
              }
            } else {
              rapidRiseIcon = 'â­•';
              rapidRiseStatus = 'Ù„Ù… ÙŠØ­Ù‚Ù‚ Ø§Ø±ØªÙØ§Ø¹ 10% Ø¨Ø¹Ø¯';
            }
            
            // Price comparison display
            let priceComparisonDisplay = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if (t.previousHighPrice && t.currentHighPrice) {
              const priceRatio = (t.currentHighPrice / t.previousHighPrice).toFixed(4);
              priceComparisonDisplay = `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚: ${t.previousHighPrice.toFixed(8)} â†’ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${t.currentHighPrice.toFixed(8)} (Ù†Ø³Ø¨Ø©: ${priceRatio}x)`;
            }
            
            return `
              <div class="token-block" style="${t.browserFailed ? 'border-left: 4px solid #ff9800;' : ''}">
                <div class="token-row"><span class="token-label">â° ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:</span> <span>${t.startTime.toLocaleString('sv-SE').replace('T',' ')}</span></div>
                <div class="token-row"><span class="token-label">ğŸ”¹ Ø§Ù„ØªÙˆÙƒÙ†:</span> <span class="token-value">${t.token}</span></div>
                <div class="token-row"><span class="token-label">ğŸ›¡ï¸ Ø­Ø§Ù„Ø© rugcheck.xyz:</span> <span style="color: ${t.rugcheckStatus === 'GOOD' ? '#4CAF50' : t.rugcheckStatus === 'DANGER' ? '#F44336' : t.rugcheckStatus === 'WARNING' ? '#FF9800' : '#666'}; font-weight: bold;">${t.rugcheckStatus === 'GOOD' ? 'âœ… Ø¢Ù…Ù†' : t.rugcheckStatus === 'DANGER' ? 'âš ï¸ Ø®Ø·Ø±' : t.rugcheckStatus === 'WARNING' ? 'ğŸ”¶ ØªØ­Ø°ÙŠØ±' : 'â“ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚'}</span></div>
                <div class="token-row"><span class="token-label">ï¿½ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø©:</span> <span style="color: ${liquidityColor}; font-weight: bold;">${liquidityIcon} ${liquidityText}</span></div>
                <div class="token-row"><span class="token-label">ï¿½ğŸ’µ Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø±Ø§Ù‚Ø¨:</span> <span>${firstPriceDisplay}</span></div>
                <div class="token-row"><span class="token-label">ğŸ“ˆ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙˆØµÙ„Ù‡:</span> <span style="color:green">${lastPriceDisplay}</span></div>
                <div class="token-row"><span class="token-label">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø£ÙˆÙ„ Ø³Ø¹Ø±:</span> <span>${percent}</span></div>
                <div class="token-row"><span class="token-label">ï¿½ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:</span> <span style="font-weight:bold; color:#ff6b35;">${priceComparison}</span></div>
                <div class="token-row"><span class="token-label">ï¿½ğŸš€ Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class="token-status">${statusIcon} ${statusText}</span></div>
                <div class="token-row"><span class="token-label">â³ Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:</span> <span>${duration}</span></div>
                <div class="token-row"><span class="token-label">ğŸ” Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:</span> <span style="font-weight:bold; color:#2196F3;">${priceComparisonDisplay}</span></div>
                <div class="token-row"><span class="token-label">âš¡ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø±ÙŠØ¹:</span> <span class="token-status" style="color: ${t.rapidRiseAchieved ? '#4CAF50' : '#FF9800'};">${rapidRiseIcon} ${rapidRiseStatus}</span></div>
                <form method="POST" action="/delete_token" style="display:inline;">
                  <input type="hidden" name="token" value="${t.token}" />
                  <button type="submit" class="delete-btn">Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                </form>
              </div>
            `;
          }).join('')}
        </div>
        ${Object.keys(trackedTokens).length === 0 ? '<div style="text-align: center; color: #666; font-size: 1.2em; margin-top: 50px;">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆÙƒÙ†Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>' : ''}
      </body>
      </html>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/delete_token") {
    let body = "";
    req.on("data", chunk => { body += chunk.toString(); });
    req.on("end", () => {
      const params = new URLSearchParams(body);
      const token = params.get("token");
      stopTrackingToken(token);
      res.writeHead(302, { Location: "/track_token" });
      res.end();
    });
    return;
  }
  // ...existing code...
}).listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸŒ HTTP Server running on port ${PORT}`);
  console.log(`ğŸŒ Server accessible at: http://0.0.0.0:${PORT}`);
});

// Ø§Ø³ØªØ®Ø¯Ø§Ù… URL Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù„Ù€ keep-alive Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø©
const KEEP_ALIVE_URL = process.env.RENDER_EXTERNAL_URL || "https://cdcd.onrender.com";
setInterval(() => {
  const targetUrl = KEEP_ALIVE_URL + "/health";
  const protocol = targetUrl.startsWith('https://') ? https : http;
  
  protocol.get(targetUrl, (res) => {
    console.log(`ğŸ”„ Keep Alive Ping: ${targetUrl} - Status: ${res.statusCode}`);
  }).on("error", (e) => {
    console.error(`âŒ Keep Alive Error: ${e.message}`);
  });
}, 10 * 60 * 1000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
process.on('exit', () => {
  logLoginLogout('logout');
  saveTrackedTokens();
});

process.on('SIGINT', async () => {
  console.log('\nğŸ›‘ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬...');
  logLoginLogout('logout');
  saveTrackedTokens();
  await closeSharedBrowser();
  console.log('ğŸ‘‹ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø£Ù…Ø§Ù†');
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('\nğŸ›‘ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬...');
  logLoginLogout('logout');
  saveTrackedTokens();
  await closeSharedBrowser();
  console.log('ğŸ‘‹ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø£Ù…Ø§Ù†');
  process.exit(0);
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
process.on('uncaughtException', async (error) => {
  console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
  await closeSharedBrowser();
  process.exit(1);
});

process.on('unhandledRejection', async (reason, promise) => {
  console.error('âŒ ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶:', reason);
  await closeSharedBrowser();
  process.exit(1);
});

const sentTokensFile = 'sent_tokens.txt';
let sentTokens = new Set();
if (fs.existsSync(sentTokensFile)) {
  const tokens = fs.readFileSync(sentTokensFile, 'utf8').split('\n').filter(Boolean);
  sentTokens = new Set(tokens);
}

// ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± ØªÙ‚Ù„ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„/Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ (I/O) ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
const executionLogsBuffer = [];

// ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
setInterval(() => {
  if (executionLogsBuffer.length > 0) {
    fs.appendFileSync('execution_logs.txt', executionLogsBuffer.join(''), 'utf8');
    executionLogsBuffer.length = 0;
  }
}, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù

// Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…ØªØªØ¨Ø¹Ø© ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
setInterval(() => {
  saveTrackedTokens();
}, 300000); // ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
setInterval(() => {
  if (global.gc) {
    global.gc();
    console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
  }
}, 600000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
