const { TelegramClient } = require("telegram");
const { StringSession } = require("telegram/sessions");
const fs = require("fs");
const input = require("input");
const http = require("http");
const https = require("https");

const { performance } = require('perf_hooks');
const puppeteer = require('puppeteer');
// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
const trackedTokens = {};

// Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙˆÙƒÙ† Ø¬Ø¯ÙŠØ¯
async function startTrackingToken(token) {
  if (trackedTokens[token]) return;
  const url = `https://gmgn.ai/sol/token/${token}`;
  const startTime = new Date();
  let firstPrice = null;
  let lastPrice = null;
  let maxIncrease = 0;
  let reached50 = false;
  let stopped = false;

  // Ø¥Ø·Ù„Ø§Ù‚ Ù…ØªØµÙØ­ Puppeteer Ù„ÙƒÙ„ ØªÙˆÙƒÙ† Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªØµÙØ­ Ø­Ù‚ÙŠÙ‚ÙŠ
  const browser = await puppeteer.launch({ headless: false, args: ['--no-sandbox', '--disable-blink-features=AutomationControlled'] });
  const page = await browser.newPage();
  // ØªØ¹ÙŠÙŠÙ† user-agent Ø­Ù‚ÙŠÙ‚ÙŠ
  await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
  // Ø¥Ø²Ø§Ù„Ø© Ù…ØªØºÙŠØ±Ø§Øª ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØªÙ…ØªØ©
  await page.evaluateOnNewDocument(() => {
    Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
  });
  await page.goto(url, { waitUntil: 'networkidle2', timeout: 360000 });

  // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ Ø³Ø¹Ø±
  async function getPrice() {
    try {
      // Ø¬Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø³Ù„ÙƒØªÙˆØ± .price
      await page.waitForSelector('.price', { timeout: 7000 });
      const priceText = await page.$eval('.price', el => el.textContent);
      const price = parseFloat(priceText.replace(/[^\d.]/g, ''));
      if (!isNaN(price)) {
        console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† .price:`, price);
        return price;
      }
    } catch (e) {
      console.log(`[${token}] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ .price Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£:`, e.message);
    }
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ .price Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† ÙƒÙ„ Ø§Ù„ØµÙØ­Ø©
    try {
      const bodyText = await page.evaluate(() => document.body.innerText);
      // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø±Ù‚Ù… Ø¯ÙˆÙ„Ø§Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
      const match = bodyText.match(/\$([0-9]+\.[0-9]+)/);
      if (match && match[1]) {
        const price = parseFloat(match[1]);
        if (!isNaN(price)) {
          console.log(`[${token}] ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¹Ø¨Ø± regex:`, price);
          return price;
        }
      }
      // Ø§Ø·Ø¨Ø¹ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­
      console.log(`[${token}] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙØ­Ø©:\n`, bodyText.slice(0, 500));
    } catch (e) {
      console.log(`[${token}] Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù†Øµ Ø§Ù„ØµÙØ­Ø©:`, e.message);
    }
    return null;
  }

  // ÙƒØ±Ø± Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ„ Ø­ØªÙ‰ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©
  while (firstPrice === null) {
    firstPrice = await getPrice();
    if (firstPrice === null) {
      await new Promise(r => setTimeout(r, 2000)); // Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØªÙŠÙ† ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    }
  }
  lastPrice = firstPrice;
  trackedTokens[token] = {
    token,
    startTime,
    firstPrice, // Ø³ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨ØªÙ‹Ø§
    lastPrice,
    maxIncrease,
    reached50,
    stopped,
    browser,
    page
  };

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
  (async function updateLoop() {
    while (trackedTokens[token] && !trackedTokens[token].stopped) {
      const price = await getPrice();
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙˆÙ„Ù… ÙŠÙØ­Ø°Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      if (!trackedTokens[token]) break;
      if (price) {
        // ØªØ­Ø¯ÙŠØ« lastPrice ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (price > trackedTokens[token].lastPrice) {
          trackedTokens[token].lastPrice = price;
        }
        // Ù„Ø§ ØªØºÙŠØ± firstPrice Ø¨Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ†Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø©
        const increase = ((price - trackedTokens[token].firstPrice) / trackedTokens[token].firstPrice) * 100;
        if (increase > trackedTokens[token].maxIncrease) trackedTokens[token].maxIncrease = increase;
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØµÙ„ Ø¨Ø¹Ø¯ Ø¥Ù„Ù‰ 50% ÙˆØ­Ù‚Ù‚Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŒ Ø«Ø¨Ù‘Øª reached50 Ø¹Ù„Ù‰ true
        if (!trackedTokens[token].reached50 && increase >= 50) {
          trackedTokens[token].reached50 = true;
        }
      }
      await new Promise(r => setTimeout(r, 10000));
    }
    await browser.close();
  })();
}

// Ø­Ø°Ù Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
function stopTrackingToken(token) {
  if (trackedTokens[token]) {
    trackedTokens[token].stopped = true;
    delete trackedTokens[token];
  }
}

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø³ÙŠØ±ÙØ±
const PHONE_NUMBER = "+967xxxxxxxxx";  // Ø¶Ø¹ Ø±Ù‚Ù…Ùƒ Ù‡Ù†Ø§
const PASSWORD = "YOUR_PASSWORD"; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 2FA
const PHONE_CODE = undefined; // ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ undefined Ù„ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡

const apiId = 23299626;
const apiHash = "89de50a19288ec535e8b008ae2ff268d";

console.log("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±!");

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
function logLoginLogout(type) {
  const logFile = 'login_logout_log.txt';
  const now = new Date().toISOString();
  fs.appendFileSync(logFile, `${type},${now}\n`, 'utf8');
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
logLoginLogout('login');

// Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ù…Ù„Ù
let stringSession = new StringSession("");

if (fs.existsSync("session.txt")) {
  const savedSession = fs.readFileSync("session.txt", "utf8");
  stringSession = new StringSession(savedSession.trim());
}

(async () => {
  console.log("ğŸ“² Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙ„ÙŠØ¬Ø±Ø§Ù…...");
  const client = new TelegramClient(stringSession, apiId, apiHash, {
    connectionRetries: 5,
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·
  try {
    await client.start({
      phoneNumber: async () => PHONE_NUMBER,
      password: async () => PASSWORD,
      phoneCode: async () => PHONE_CODE,
      onError: (err) => console.log("âŒ Ø®Ø·Ø£:", err),
    });
  } catch (err) {
    if (err.errorMessage === 'AUTH_KEY_DUPLICATED') {
      console.error('âŒ AUTH_KEY_DUPLICATED: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©.');
      fs.unlinkSync('session.txt'); // Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      stringSession = new StringSession(""); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©
      await client.start({
        phoneNumber: async () => PHONE_NUMBER,
        password: async () => PASSWORD,
        phoneCode: async () => PHONE_CODE,
        onError: (err) => console.log("âŒ Ø®Ø·Ø£:", err),
      });
    } else {
      throw err; // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† AUTH_KEY_DUPLICATED
    }
  }

  console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
  const sessionString = client.session.save();

  // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠ
  fs.writeFileSync("session.txt", sessionString);
  console.log("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ session.txt");

  await client.sendMessage("me", { message: "ğŸš€ Ø¨ÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø´ØºØ§Ù„!" });

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø­ÙŠØ§Ø©
  const joinedBotsFile = 'joined_bots.txt';
  if (!fs.existsSync(joinedBotsFile)) {
    try {
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      const botsToJoin = ['GMGN_sol_bot', 'solBigamout'];
      for (const bot of botsToJoin) {
        // Ø£Ø±Ø³Ù„ ÙÙ‚Ø· Ù„Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€ _bot
        if (bot.endsWith('_bot')) {
          await client.sendMessage(bot, { message: '/start' });
          await sleep(2000);
        } else {
          console.log(`âš ï¸ ØªØ®Ø·ÙŠ ${bot}: Ù„ÙŠØ³ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù….`);
        }
      }
      fs.writeFileSync(joinedBotsFile, 'done');
      console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.');
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨ÙˆØªØ§Øª:', err.message);
    }
  }

  // Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
  client.addEventHandler(async (update) => {
    try {
      // ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø² Ø§Ù„Ø±Ø§Ø¨Ø¹
      if (update.message && typeof update.message.message === "string") {
        const msg = update.message;
        const text = msg.message;

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "counts: 1" Ø£Ùˆ Ø£ÙƒØ«Ø± Ùˆ"60 SOL" Ø£Ùˆ Ø£ÙƒØ«Ø±
        if (/\bcounts:\s*(\d+)\b/i.test(text) && parseInt(text.match(/\bcounts:\s*(\d+)\b/i)[1]) >= 1 &&
            /([6-9]\d|\d{3,})\.\d{2}\s*SOL(\D|$)/.test(text)) {

          // ÙÙ„ØªØ±Ø© "5m" Ø¨Ø­ÙŠØ« ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0% Ùˆ 3000%
          const fiveMinMatch = text.match(/5m\s*\((\d+\.\d+)%\)/);
          if (fiveMinMatch) {
            const fiveMinPercentage = parseFloat(fiveMinMatch[1]);
            if (fiveMinPercentage > 3000) {
              console.log(`âš ï¸ Ø§Ù„Ù†Ø³Ø¨Ø© 5m (${fiveMinPercentage}%) Ø£ÙƒØ¨Ø± Ù…Ù† 3000%. ØªØ®Ø·ÙŠ.`);
              return;
            }
          }

          // Ø§Ù„ÙØ±Ø² Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (d) ÙŠØ³Ø§ÙˆÙŠ 0
          const ageMatch = text.match(/age:\s*(\d+)d\s*(\d+)h/);
          if (ageMatch) {
            const days = parseInt(ageMatch[1]);
            if (days !== 0) {
              console.log(`âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (d) Ù„ÙŠØ³ 0. ØªØ®Ø·ÙŠ.`);
              return;
            }
          }

          // ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¹Ø± price: $... ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 0.01
          const priceMatch = text.match(/price:\s*\$?([\deE\.-]+)/i);
          if (priceMatch && priceMatch[1]) {
            let priceValue = parseFloat(priceMatch[1]);
            if (isNaN(priceValue)) {
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØµÙŠØºØ© Ø¹Ù„Ù…ÙŠØ©
              try {
                priceValue = Number(priceMatch[1]);
              } catch {}
            }
            if (!(priceValue < 0.01)) {
              console.log(`âš ï¸ Ø§Ù„Ø³Ø¹Ø± ${priceValue} Ø£ÙƒØ¨Ø± Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ 0.01. ØªØ®Ø·ÙŠ.`);
              return;
            }
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø±ØŒ ØªØ®Ø·Ù‰
            console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©. ØªØ®Ø·ÙŠ.');
            return;
          }

          const startTime = performance.now();
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ø¹Ø¯ ca:
          const caMatch = text.match(/ca:\s*([\w]+)/);
          if (caMatch && caMatch[1]) {
            const token = caMatch[1];
            if (sentTokens.has(token)) {
              console.log(`âš ï¸ Ø§Ù„ØªÙˆÙƒÙ† ${token} ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§. ØªØ®Ø·ÙŠ.`);
              return;
            }
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙˆÙƒÙ† ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ca:
            console.log(token);
            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…Ù„Ù Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¨ÙˆØª sniperoo
            fs.writeFileSync('last_token.txt', token, 'utf8');

            // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¶ÙˆØ¡

            // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù„Ø­Ø¸Ø© (Ø²Ù…Ù† Ø¨Ù„Ø§Ù†Ùƒ)
            const buyMsg = `/buy ${token} ${buyPrice}`;
            client.sendMessage(botUsername, { message: buyMsg });
            client.sendMessage(botUsername, { message: token });
            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', buyMsg);
            console.log('ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡.');

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©
            sentTokens.add(token);
            fs.appendFileSync(sentTokensFile, `${token}\n`, 'utf8');

            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙˆÙƒÙ†
            startTrackingToken(token);

            const endTime = performance.now();
            const executionTimeLog = `â±ï¸ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ù„ØªÙˆÙƒÙ† ${token}: ${(endTime - startTime).toFixed(2)} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©.`;
            console.log(executionTimeLog);
            executionLogsBuffer.push(`${executionTimeLog}\n`);
          }
        }
      }
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", err.message);
    }
  });
})();

const botUsername = 'GMGN_sol_bot';

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø¨ÙˆØª GMGN
async function tradeInGMGNBot(client, token) {
  const lastStartFile = 'gmgn_last_start.txt';
  let shouldSendStart = true;
  try {
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ /start
    if (fs.existsSync(lastStartFile)) {
      const lastStartDate = fs.readFileSync(lastStartFile, 'utf8').trim();
      const today = new Date().toISOString().slice(0, 10);
      if (lastStartDate === today) {
        shouldSendStart = false;
      }
    }
    // Ø¥Ø±Ø³Ø§Ù„ /start Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙŠÙˆÙ…ÙŠØ§Ù‹
    if (shouldSendStart) {
      await client.sendMessage(botUsername, { message: '/start' });
      fs.writeFileSync(lastStartFile, new Date().toISOString().slice(0, 10));
      await sleep(2000);
    }
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†
    await client.sendMessage(botUsername, { message: token });
    await sleep(3000);

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª ÙˆØ·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±
    let price = null;
    let done = false;
    let lastBotMessage = null;
    const handler = async (update) => {
      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø¨ÙˆØª GMGN Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ peerId
      if (update.message && update.message.peerId && (
            (update.message.peerId.userId && update.message.peerId.userId.toString().includes('GMGN')) ||
            (update.message.peerId.channelId && botUsername.includes('GMGN'))
          )) {
        const text = update.message.message;
        lastBotMessage = text;
        // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        if (text.includes(token)) {
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          let priceMatch = text.match(/price:\s*\$?([\d\.]+)/i);
          if (priceMatch && priceMatch[1]) {
            price = parseFloat(priceMatch[1]);
            done = true;
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
            console.log('ğŸ“© Ø§Ù„Ø³Ø¹Ø± Ù…Ù† GMGN: ' + priceMatch[1]);
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø²ÙŠØ§Ø¯Ø© 1000%
            const newPrice = (price * 10).toFixed(6);
            // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
            const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
            await client.sendMessage(botUsername, { message: orderMsg });
            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„:', orderMsg);
          } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø±ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø©
            console.log('ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† GMGN:\n' + text);
          }
        }
      }
    };
    client.addEventHandler(handler);
    // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©
    let tries = 0;
    while (!done && tries < 10) {
      await sleep(1000);
      tries++;
    }
    client.removeEventHandler(handler);
    if (!price) {
      console.log('ğŸ“© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†:\n' + (lastBotMessage || 'Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†'));
      return;
    }
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø²ÙŠØ§Ø¯Ø© 1000%
    const newPrice = (price * 10).toFixed(6);
    // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    const orderMsg = `/create limitbuy ${token} 0.5@${newPrice} -exp 86400`;
    await client.sendMessage(botUsername, { message: orderMsg });
    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„:', orderMsg);
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù…Ø¹ GMGN:', err.message);
  }
}

// Ø¯Ø§Ù„Ø© ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·Ø©
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

let buyPrice = 0.5; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

const PORT = process.env.PORT || 3000;
http.createServer((req, res) => {
  if (req.method === "POST" && req.url === "/delete-all") {
    // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    fs.writeFileSync('execution_logs.txt', '', 'utf8');
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <div style='text-align:center;'>
        <div style='font-size:2em;'>ğŸš€ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!</div>
        <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      </div>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/update-price") {
    let body = "";
    req.on("data", chunk => {
      body += chunk.toString();
    });
    req.on("end", () => {
      const params = new URLSearchParams(body);
      const newPrice = parseFloat(params.get("price"));
      if (!isNaN(newPrice) && newPrice > 0) {
        buyPrice = newPrice;
        res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em;'>âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${buyPrice}</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
        `);
      } else {
        res.writeHead(400, { "Content-Type": "text/html; charset=utf-8" });
        res.end(`
          <div style='text-align:center;'>
            <div style='font-size:2em; color:red;'>âŒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¯Ø®Ù„ ØºÙŠØ± ØµØ§Ù„Ø­!</div>
            <a href="/" style='font-size:1.5em; color:#0078D7;'>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
        `);
      }
    });
    return;
  }

  // ...existing code...
  if (req.method === "GET" && req.url.startsWith("/track_token")) {
    res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
    res.end(`
      <html lang="ar">
      <head>
        <title>Token Tracker</title>
        <meta http-equiv="refresh" content="10">
        <style>
          body { font-family: Tahoma, Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 0; direction: rtl; }
          h2 { text-align: center; color: #0078D7; margin-top: 30px; letter-spacing: 1px; }
          .tokens-container { max-width: 700px; margin: 30px auto; }
          .token-block {
            background: #fff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px #0001;
            padding: 18px 22px 12px 22px;
            margin-bottom: 18px;
            border-radius: 10px;
            transition: box-shadow 0.2s;
            position: relative;
          }
          .token-block:hover { box-shadow: 0 4px 16px #0002; }
          .token-label { color: #333; font-weight: bold; display: inline-block; min-width: 170px; }
          .token-value { color: #0078D7; font-weight: bold; }
          .token-status { font-size: 1.1em; }
          .delete-btn {
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 7px 18px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
          }
          .delete-btn:hover { background: #b71c1c; }
          .token-row { margin-bottom: 7px; }
        </style>
      </head>
      <body>
        <h2>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª (Token Tracker)</h2>
        <div class="tokens-container">
        ${Object.values(trackedTokens)
          .sort((a, b) => b.startTime - a.startTime) // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
          .map(t => {
            let percent = '';
            if (t.firstPrice && t.lastPrice) {
              const p = ((t.lastPrice - t.firstPrice) / t.firstPrice) * 100;
              percent = (p >= 0 ? '+' : '') + p.toFixed(2) + '%';
            } else {
              percent = '...';
            }
            // Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© hh:mm:ss
            let duration = '...';
            if (t.startTime) {
              const ms = Date.now() - t.startTime.getTime();
              const totalSeconds = Math.floor(ms / 1000);
              const hours = Math.floor(totalSeconds / 3600);
              const minutes = Math.floor((totalSeconds % 3600) / 60);
              const seconds = totalSeconds % 60;
              duration = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            }
            return `
              <div class="token-block">
                <div class="token-row"><span class="token-label">â° ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:</span> <span>${t.startTime.toLocaleString('sv-SE').replace('T',' ')}</span></div>
                <div class="token-row"><span class="token-label">ğŸ”¹ Ø§Ù„ØªÙˆÙƒÙ†:</span> <span class="token-value">${t.token}</span></div>
                <div class="token-row"><span class="token-label">ğŸ’µ Ø£ÙˆÙ„ Ø³Ø¹Ø± Ù…Ø±Ø§Ù‚Ø¨:</span> <span>${t.firstPrice ? t.firstPrice+'$' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}</span></div>
                <div class="token-row"><span class="token-label">ğŸ“ˆ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙˆØµÙ„Ù‡:</span> <span style="color:green">${t.lastPrice ? t.lastPrice+'$' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}</span></div>
                <div class="token-row"><span class="token-label">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø£ÙˆÙ„ Ø³Ø¹Ø±:</span> <span>${percent}</span></div>
                <div class="token-row"><span class="token-label">ğŸš€ Ù‡Ù„ Ø§Ø±ØªÙØ¹ 50% Ø£Ùˆ Ø£ÙƒØ«Ø±:</span> <span class="token-status">${t.reached50 ? 'âœ…ï¸' : 'âŒï¸'}</span></div>
                <div class="token-row"><span class="token-label">â³ Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:</span> <span>${duration}</span></div>
                <form method="POST" action="/delete_token" style="display:inline;">
                  <input type="hidden" name="token" value="${t.token}" />
                  <button type="submit" class="delete-btn">Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
                </form>
              </div>
            `;
          }).join('')}
        </div>
      </body>
      </html>
    `);
    return;
  }

  if (req.method === "POST" && req.url === "/delete_token") {
    let body = "";
    req.on("data", chunk => { body += chunk.toString(); });
    req.on("end", () => {
      const params = new URLSearchParams(body);
      const token = params.get("token");
      stopTrackingToken(token);
      res.writeHead(302, { Location: "/track_token" });
      res.end();
    });
    return;
  }
  // ...existing code...
}).listen(PORT, () => {
  console.log(`ğŸŒ HTTP Server running on port ${PORT}`);
});

const KEEP_ALIVE_URL = "https://cdcd.onrender.com/";
setInterval(() => {
  https.get(KEEP_ALIVE_URL, (res) => {
    console.log(`ğŸ”„ Keep Alive Ping: ${KEEP_ALIVE_URL} - Status: ${res.statusCode}`);
  }).on("error", (e) => {
    console.error(`âŒ Keep Alive Error: ${e.message}`);
  });
}, 10 * 60 * 1000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
process.on('exit', () => {
  logLoginLogout('logout');
});
process.on('SIGINT', () => {
  logLoginLogout('logout');
  process.exit();
});

const sentTokensFile = 'sent_tokens.txt';
let sentTokens = new Set();
if (fs.existsSync(sentTokensFile)) {
  const tokens = fs.readFileSync(sentTokensFile, 'utf8').split('\n').filter(Boolean);
  sentTokens = new Set(tokens);
}

// ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± ØªÙ‚Ù„ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„/Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ (I/O) ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
const executionLogsBuffer = [];

// ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
setInterval(() => {
  if (executionLogsBuffer.length > 0) {
    fs.appendFileSync('execution_logs.txt', executionLogsBuffer.join(''), 'utf8');
    executionLogsBuffer.length = 0;
  }
}, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
