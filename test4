const { TelegramClient } = require("telegram");
const { StringSession } = require("telegram/sessions");
const fs = require("fs");
const input = require("input");
const http = require("http");
const https = require("https");


const PHONE_NUMBER = "+967781430676"; // Ø¶Ø¹ Ø±Ù‚Ù…Ùƒ Ù‡Ù†Ø§
const PASSWORD = "YOUR_PASSWORD"; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 2FA
const PHONE_CODE = undefined; // ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ undefined Ù„ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡

const apiId = 23299626;
const apiHash = "89de50a19288ec535e8b008ae2ff268d";

console.log("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±!");

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
function logLoginLogout(type) {
  const logFile = 'login_logout_log.txt';
  const now = new Date().toISOString();
  fs.appendFileSync(logFile, `${type},${now}\n`, 'utf8');
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
logLoginLogout('login');

// Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ù…Ù„Ù
let stringSession = new StringSession("");

if (fs.existsSync("session.txt")) {
  const savedSession = fs.readFileSync("session.txt", "utf8");
  stringSession = new StringSession(savedSession.trim());
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙƒØ§Ø¦Ù† client ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
const client = new TelegramClient(stringSession, apiId, apiHash, {
  connectionRetries: 5,
});

(async () => {
  console.log("ğŸ“² Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙ„ÙŠØ¬Ø±Ø§Ù…...");

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·
  await client.start({
    phoneNumber: async () => PHONE_NUMBER,
    password: async () => PASSWORD,
    phoneCode: async () => await input.text("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:"),
    onError: (err) => console.log("âŒ Ø®Ø·Ø£:", err),
  });

  console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
  const sessionString = client.session.save();

  // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠ
  fs.writeFileSync("session.txt", sessionString);
  console.log("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ session.txt");

  await client.sendMessage("me", { message: "ğŸš€ Ø¨ÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø´ØºØ§Ù„!" });
})();

// Ø¯Ø§Ù„Ø© ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·Ø©
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const PORT = process.env.PORT || 3100;
http.createServer((req, res) => {
  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©
  let count = 0;
  try {
    const logFile = 'login_logout_log.txt';
    if (fs.existsSync(logFile)) {
      const logs = fs.readFileSync(logFile, 'utf8').split('\n').filter(Boolean);
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;
      count = logs.filter(line => {
        const [, time] = line.split(',');
        return now - new Date(time).getTime() <= oneDay;
      }).length;
    }
  } catch {}
  res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
  res.end(`
    <div style='text-align:center;'>
      <div style='font-size:2em;'>ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† 24 Ø³Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±!</div>
      <div style='margin-top:20px; font-size:3em; color:#0078D7; font-weight:bold;'>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©: ${count}</div>
    </div>
  `);
}).listen(PORT, () => {
  console.log(`ğŸŒ HTTP Server running on port ${PORT}`);
});

const KEEP_ALIVE_URL = "https://cdcdcd.onrender.com/";
setInterval(() => {
  https.get(KEEP_ALIVE_URL, (res) => {
    console.log(`ğŸ”„ Keep Alive Ping: ${KEEP_ALIVE_URL} - Status: ${res.statusCode}`);
  }).on("error", (e) => {
    console.error(`âŒ Keep Alive Error: ${e.message}`);
  });
}, 10 * 60 * 1000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
process.on('exit', () => {
  logLoginLogout('logout');
});
process.on('SIGINT', () => {
  logLoginLogout('logout');
  process.exit();
});

// ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø­Ø« ÙŠØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
const tokenData = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§

client.addEventHandler(async (update) => {
  try {
    if (update.message && typeof update.message.message === "string") {
      const msg = update.message;
      const text = msg.message;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "COUNTS: X"
      const countMatch = text.match(/COUNTS:\s*(\d+)/i);
      const tokenMatch = text.match(/ca:\s*([\w]+)/i);

      if (countMatch && tokenMatch) {
        const count = parseInt(countMatch[1], 10);
        const token = tokenMatch[1];
        const now = Date.now();

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ "COUNTS: 1"
        if (count === 1) {
          tokenData[token] = [{ count, timestamp: now }];
          fs.writeFileSync(`${token}.txt`, `${token} : Counts: 1\n`, 'utf8');
        } else if (tokenData[token]) {
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "COUNTS: X" Ø­ÙŠØ« X > 1
          const previous = tokenData[token][tokenData[token].length - 1];
          const timeDiff = Math.round((now - previous.timestamp) / 1000); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ù
          tokenData[token].push({ count, timestamp: now });
          fs.appendFileSync(
            `${token}.txt`,
            `Counts: ${count} To Counts: ${previous.count} = ${timeDiff}second\n`,
            'utf8'
          );
        }
      }
    }
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:", err.message);
  }
});
